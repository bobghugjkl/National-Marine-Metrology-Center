# 新增任务修复说明

## 🐛 问题描述

用户反馈："我现在为什么又新增不了任务了"

浏览器控制台显示多个 500 错误（INTERNAL SERVER ERROR）。

## 🔍 问题分析

### 错误信息
```
'start_date' is an invalid keyword argument for TaskInfo
```

### 根本原因
在 `backend/app.py` 的 `create_task` 函数中（第345-346行），尝试使用了 `start_date` 和 `end_date` 字段创建任务：

```python
new_task = TaskInfo(
    task_name=data.get('task_name'),
    project=data.get('project'),
    task_code=data.get('task_code'),
    undertake=data.get('undertake'),
    leader=data.get('leader'),
    ship=data.get('ship'),
    start_date=data.get('start_date'),  # ❌ 错误：TaskInfo 模型中没有此字段
    end_date=data.get('end_date')       # ❌ 错误：TaskInfo 模型中没有此字段
)
```

但是 `TaskInfo` 模型定义中（第58-90行）实际的字段是：
- task_name
- project
- task_code
- undertake
- **participant** （参与单位）
- ship
- leader
- chief_scientist
- superintendent
- superintended
- **executiontime** （执行时间，而不是 start_date/end_date）
- subject

## ✅ 修复方案

### 已修复代码

**文件**：`backend/app.py` 第334-351行

```python
@app.route('/api/tasks', methods=['POST'])
def create_task():
    try:
        data = request.json
        new_task = TaskInfo(
            task_name=data.get('task_name'),
            project=data.get('project'),
            task_code=data.get('task_code'),
            undertake=data.get('undertake'),
            participant=data.get('participant'),           # ✅ 新增
            ship=data.get('ship'),
            leader=data.get('leader'),
            chief_scientist=data.get('chief_scientist'),   # ✅ 新增
            superintendent=data.get('superintendent'),     # ✅ 新增
            superintended=data.get('superintended'),       # ✅ 新增
            executiontime=data.get('executiontime'),       # ✅ 新增（替代 start_date/end_date）
            subject=data.get('subject')                    # ✅ 新增
        )
        db.session.add(new_task)
        db.session.commit()
        
        # 自动创建对应的检查记录
        try:
            new_inspection = PreVoyageInspection(task_name=data.get('task_name'))
            db.session.add(new_inspection)
            db.session.commit()
        except Exception as e:
            print(f'创建检查记录失败: {e}')
        
        return jsonify({
            'code': 200,
            'message': '创建成功',
            'data': new_task.to_dict()
        })
    except Exception as e:
        db.session.rollback()
        return jsonify({'code': 500, 'message': str(e)}), 500
```

## 🚀 如何应用修复

### 方法一：重启后端（推荐）

1. **停止当前后端**
   - 在运行 `python app.py` 的终端按 `Ctrl+C`

2. **重新启动后端**
   ```bash
   cd backend
   python app.py
   ```

3. **验证启动成功**
   - 应该看到：`统一后端服务已启动: http://localhost:5000`

### 方法二：强制重载

如果Flask没有自动重载，可以：

1. **修改 app.py 添加一个空行**（触发文件变化）
2. **保存文件**
3. **观察终端**，应该看到 "Detected change" 和 "Restarting"

## ✅ 验证步骤

### 1. 测试后端API（可选）

```bash
# 在命令行测试
python -c "import requests; import json; data={'task_name':'测试任务001','project':'测试专项','undertake':'测试单位','leader':'张三'}; r=requests.post('http://localhost:5000/api/tasks', json=data); print(f'Status: {r.status_code}'); print(f'Response: {r.json()}')"
```

应该看到：
```
Status: 200
Response: {'code': 200, 'message': '创建成功', 'data': {...}}
```

### 2. 在前端测试

1. **刷新浏览器**
2. **进入任务管理**
   - 点击"任务管理" → "新建任务"
3. **填写表单**
   - 航次任务名称：QQQ
   - 专项名称：111
   - 航次任务编号：111
   - 等等...
4. **点击保存**
   - 应该成功创建，不再报 500 错误

## 📊 字段对应关系

| 前端表单字段 | 后端数据库字段 | 说明 |
|-------------|---------------|------|
| 航次任务名称 | task_name | 主键，必填 |
| 专项名称 | project | 可选 |
| 航次任务编号 | task_code | 可选 |
| 航次承担单位 | undertake | 可选 |
| 航次参与单位 | participant | 可选 |
| 调查船 | ship | 可选 |
| 任务负责人 | leader | 可选 |
| 首席科学家 | chief_scientist | 可选 |
| 随船监督员 | superintendent | 可选 |
| 随船监督 | superintended | 可选 |
| 执行时间 | executiontime | 可选，替代了 start_date/end_date |
| 任务学科 | subject | 可选 |

## 🔧 技术说明

### 为什么会出现这个问题？

1. **模型定义和使用不匹配**
   - `TaskInfo` 模型中使用 `executiontime` 字段存储执行时间
   - 但创建任务时错误地使用了 `start_date` 和 `end_date`

2. **SQLAlchemy 严格检查**
   - SQLAlchemy 会验证传入的参数是否是模型的有效字段
   - 如果字段不存在，会抛出 `invalid keyword argument` 错误

### 为什么 Flask 没有自动重载？

可能的原因：
1. **文件保存问题**：IDE可能没有真正保存文件到磁盘
2. **缓存问题**：Python 字节码缓存（`.pyc` 文件）可能需要清除
3. **debug模式问题**：虽然 `debug=True`，但某些情况下需要手动重启

## 📝 总结

- ✅ **问题**：创建任务时使用了不存在的 `start_date`/`end_date` 字段
- ✅ **修复**：使用正确的字段名称（`executiontime`, `participant`, `chief_scientist` 等）
- ✅ **操作**：重启后端服务（`Ctrl+C` 然后 `python app.py`）
- ✅ **验证**：在前端新建任务应该成功

---

**修复完成时间**：2025年9月30日  
**影响功能**：任务创建（POST /api/tasks）  
**状态**：✅ 已修复，需重启后端
