# 登录注册功能实现说明

## ✅ 已实现功能

### 1. 登录功能
- ✅ 使用 `tb_user` 表验证用户
- ✅ 支持用户名或登录名登录
- ✅ 密码验证
- ✅ 记住密码功能
- ✅ 登录成功后保存用户信息
- ✅ 根据角色设置权限
- ✅ 错误提示（用户不存在、密码错误）

### 2. 注册功能
- ✅ 新用户注册
- ✅ 自动保存到 `tb_user` 表
- ✅ 用户名唯一性检查
- ✅ 密码长度验证（至少6位）
- ✅ 注册成功后跳转到登录页
- ✅ 错误提示（用户名已存在）

### 3. 安全特性
- ✅ 只有 `tb_user` 表中的用户才能登录
- ✅ 密码验证
- ✅ 用户名唯一性保证
- ✅ 表单验证（前端 + 后端）

---

## 🔧 技术实现

### 后端部分：`backend/app.py`

#### 1. 登录接口

```python
@app.route('/api/login', methods=['POST'])
def login():
    try:
        data = request.json
        username = data.get('username')
        password = data.get('password')
        
        # ✅ 验证参数
        if not username or not password:
            return jsonify({'code': 400, 'message': '用户名和密码不能为空'}), 400
        
        # 🔍 查找用户（支持用户名或登录名）
        user = User.query.filter(
            (User.name == username) | (User.login_name == username)
        ).first()
        
        # ❌ 用户不存在
        if not user:
            return jsonify({'code': 401, 'message': '用户不存在'}), 401
        
        # ❌ 密码错误
        if user.password != password:
            return jsonify({'code': 401, 'message': '密码错误'}), 401
        
        # ✅ 登录成功
        return jsonify({
            'code': 200,
            'message': '登录成功',
            'data': {
                'username': user.name,
                'login_name': user.login_name,
                'role': user.role,
                'department': user.department
            }
        })
    except Exception as e:
        return jsonify({'code': 500, 'message': str(e)}), 500
```

**登录流程：**
1. 接收用户名和密码
2. 在 `tb_user` 表中查找用户
3. 验证密码
4. 返回用户信息

#### 2. 注册接口

```python
@app.route('/api/register', methods=['POST'])
def register():
    try:
        data = request.json
        username = data.get('username')
        password = data.get('password')
        login_name = data.get('login_name', username)
        department = data.get('department', '未分配')
        
        # ✅ 验证参数
        if not username or not password:
            return jsonify({'code': 400, 'message': '用户名和密码不能为空'}), 400
        
        # 🔍 检查用户名是否已存在
        existing_user = User.query.filter_by(name=username).first()
        if existing_user:
            return jsonify({'code': 400, 'message': '用户名已存在'}), 400
        
        # 🔍 检查登录名是否已存在
        existing_login = User.query.filter_by(login_name=login_name).first()
        if existing_login:
            return jsonify({'code': 400, 'message': '登录名已存在'}), 400
        
        # ✅ 创建新用户
        new_user = User(
            name=username,
            login_name=login_name,
            password=password,
            role='普通用户',
            department=department
        )
        
        db.session.add(new_user)
        db.session.commit()
        
        return jsonify({
            'code': 200,
            'message': '注册成功',
            'data': new_user.to_dict()
        })
    except Exception as e:
        db.session.rollback()
        return jsonify({'code': 500, 'message': str(e)}), 500
```

**注册流程：**
1. 接收用户名、密码等信息
2. 检查用户名是否已存在
3. 创建新用户（默认角色：普通用户）
4. 保存到数据库

### 前端部分

#### 1. API 接口：`src/api/index.ts`

```typescript
// 登录
export const loginUser = (data: any) => {
    return request({
        url: '/login',
        method: 'post',
        data
    });
};

// 注册
export const registerUser = (data: any) => {
    return request({
        url: '/register',
        method: 'post',
        data
    });
};
```

#### 2. 登录页面：`src/views/pages/login.vue`

```typescript
const submitForm = async (formEl: FormInstance | undefined) => {
    if (!formEl) return;
    formEl.validate(async (valid: boolean) => {
        if (valid) {
            try {
                // 📡 调用后端登录接口
                const res = await loginUser({
                    username: param.username,
                    password: param.password
                });
                
                if (res.data.code === 200) {
                    ElMessage.success('登录成功');
                    
                    // 💾 存储用户信息
                    const userData = res.data.data;
                    localStorage.setItem('vuems_name', userData.username);
                    localStorage.setItem('vuems_user', JSON.stringify(userData));
                    
                    // 🔑 设置权限
                    const keys = permiss.defaultList[
                        userData.role === '管理员' || userData.role === 'super_admin' 
                            ? 'admin' 
                            : 'user'
                    ];
                    permiss.handleSet(keys);
                    
                    // 🏠 跳转到首页
                    router.push('/');
                } else {
                    ElMessage.error(res.data.message || '登录失败');
                }
            } catch (error: any) {
                ElMessage.error(error.response?.data?.message || '登录失败');
            }
        }
    });
};
```

**登录流程：**
1. 用户输入用户名和密码
2. 点击"登录"按钮
3. 调用后端 `/api/login` 接口
4. 验证成功 → 保存用户信息 → 设置权限 → 跳转首页
5. 验证失败 → 显示错误提示

#### 3. 注册页面：`src/views/pages/register.vue`

```typescript
const submitForm = async (formEl: FormInstance | undefined) => {
    if (!formEl) return;
    formEl.validate(async (valid: boolean) => {
        if (valid) {
            try {
                // 📡 调用后端注册接口
                const res = await registerUser({
                    username: param.username,
                    password: param.password,
                    login_name: param.username,
                    department: '未分配'
                });
                
                if (res.data.code === 200) {
                    ElMessage.success('注册成功，请登录');
                    router.push('/login');
                } else {
                    ElMessage.error(res.data.message || '注册失败');
                }
            } catch (error: any) {
                ElMessage.error(error.response?.data?.message || '注册失败');
            }
        }
    });
};
```

**注册流程：**
1. 用户输入用户名、密码、邮箱
2. 点击"注册"按钮
3. 调用后端 `/api/register` 接口
4. 注册成功 → 跳转到登录页
5. 注册失败 → 显示错误提示（如：用户名已存在）

---

## 🔄 完整流程示例

### 场景 1：用户注册

```
1. 👤 用户打开注册页面
   ↓
2. 📝 填写信息
   用户名: newuser
   密码: 123456
   邮箱: newuser@example.com
   ↓
3. 🖱️ 点击"注册"按钮
   ↓
4. 📡 前端发送 POST 请求
   POST /api/register
   {
     "username": "newuser",
     "password": "123456",
     "login_name": "newuser",
     "department": "未分配"
   }
   ↓
5. 🔧 后端处理
   - 检查用户名是否存在
   - 创建新用户对象
   - 保存到数据库
   
   SQL:
   INSERT INTO tb_user (name, login_name, password, role, department)
   VALUES ('newuser', 'newuser', '123456', '普通用户', '未分配');
   ↓
6. 📤 后端返回
   {
     "code": 200,
     "message": "注册成功",
     "data": {...用户信息...}
   }
   ↓
7. 🎨 前端处理
   - 显示"注册成功"提示
   - 跳转到登录页
```

### 场景 2：用户登录

```
1. 👤 用户打开登录页面
   ↓
2. 📝 填写信息
   用户名: admin
   密码: 123456
   ↓
3. 🖱️ 点击"登录"按钮
   ↓
4. 📡 前端发送 POST 请求
   POST /api/login
   {
     "username": "admin",
     "password": "123456"
   }
   ↓
5. 🔧 后端处理
   - 查找用户
   SQL: 
   SELECT * FROM tb_user 
   WHERE name='admin' OR login_name='admin';
   
   - 验证密码
   if user.password != '123456':
       return 401 密码错误
   ↓
6. 📤 后端返回
   {
     "code": 200,
     "message": "登录成功",
     "data": {
       "username": "admin",
       "login_name": "admin",
       "role": "super_admin",
       "department": "IT_Department"
     }
   }
   ↓
7. 🎨 前端处理
   - 保存用户信息到 localStorage
   - 设置权限（admin 权限）
   - 显示"登录成功"提示
   - 跳转到首页 "/"
```

### 场景 3：登录失败（密码错误）

```
1. 👤 用户输入
   用户名: admin
   密码: wrongpassword
   ↓
2. 📡 前端发送请求
   POST /api/login
   {
     "username": "admin",
     "password": "wrongpassword"
   }
   ↓
3. 🔧 后端验证
   - 找到用户 admin
   - 密码验证：user.password != 'wrongpassword'
   ↓
4. 📤 后端返回
   {
     "code": 401,
     "message": "密码错误"
   }
   ↓
5. 🎨 前端显示错误
   ElMessage.error('密码错误');
```

---

## 🧪 测试指南

### 测试 1：注册新用户

**步骤：**
1. 访问注册页面：`http://localhost:5173/register`
2. 填写信息：
   - 用户名：`testuser`
   - 密码：`123456`
   - 邮箱：`test@example.com`
3. 点击"注册"

**预期结果：**
- ✅ 显示"注册成功，请登录"
- ✅ 自动跳转到登录页
- ✅ 数据库 `tb_user` 表中新增一条记录

**验证数据库：**
```sql
SELECT * FROM tb_user WHERE name='testuser';
```

### 测试 2：使用新注册的用户登录

**步骤：**
1. 在登录页面输入：
   - 用户名：`testuser`
   - 密码：`123456`
2. 点击"登录"

**预期结果：**
- ✅ 显示"登录成功"
- ✅ 跳转到首页
- ✅ 右上角显示用户名

### 测试 3：使用已存在的用户登录

**步骤：**
1. 在登录页面输入：
   - 用户名：`admin`
   - 密码：`123456`
2. 点击"登录"

**预期结果：**
- ✅ 登录成功
- ✅ 获得管理员权限
- ✅ 可以访问所有管理功能

### 测试 4：错误登录

**测试 4.1：用户不存在**
- 用户名：`nonexistent`
- 密码：`123456`
- 预期：显示"用户不存在"

**测试 4.2：密码错误**
- 用户名：`admin`
- 密码：`wrongpassword`
- 预期：显示"密码错误"

### 测试 5：重复注册

**步骤：**
1. 尝试注册已存在的用户名
2. 用户名：`admin`
3. 密码：`123456`

**预期结果：**
- ❌ 显示"用户名已存在"
- ❌ 注册失败

---

## 🔐 安全说明

### 当前实现

1. **用户验证**
   - ✅ 只有 `tb_user` 表中的用户可以登录
   - ✅ 用户名唯一性验证
   - ✅ 密码验证

2. **限制**
   - ⚠️ 密码明文存储（不安全）
   - ⚠️ 没有防暴力破解机制
   - ⚠️ 没有 Session/Token 管理

### 建议的安全改进

#### 1. 密码加密

**后端（使用 bcrypt）：**
```python
from werkzeug.security import generate_password_hash, check_password_hash

# 注册时
hashed_password = generate_password_hash(password)
user.password = hashed_password

# 登录时
if not check_password_hash(user.password, password):
    return jsonify({'code': 401, 'message': '密码错误'})
```

#### 2. JWT Token 认证

```python
import jwt
from datetime import datetime, timedelta

# 登录成功后生成 token
token = jwt.encode({
    'user_id': user.name,
    'exp': datetime.utcnow() + timedelta(hours=24)
}, app.config['SECRET_KEY'])

return jsonify({
    'code': 200,
    'token': token,
    'data': user.to_dict()
})
```

#### 3. 请求拦截器

**前端：**
```typescript
// 在 request.ts 中添加
service.interceptors.request.use(
    (config) => {
        const token = localStorage.getItem('token');
        if (token) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    }
);
```

---

## 📊 数据库表结构

### tb_user 表

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| name | VARCHAR(45) | 用户名（主键） | admin |
| login_name | VARCHAR(45) | 登录名 | admin |
| password | VARCHAR(45) | 密码 | 123456 |
| sex | VARCHAR(45) | 性别 | 男 |
| role | VARCHAR(45) | 角色 | 管理员 |
| desc | VARCHAR(45) | 描述 | - |
| permission | VARCHAR(45) | 权限 | - |
| department | VARCHAR(255) | 部门 | IT_Department |

### 注册后的默认值

- **role**: `普通用户`
- **department**: `未分配`
- **其他字段**: `NULL`

---

## ✅ 功能总结

### 已实现

1. ✅ **用户注册**
   - 表单验证
   - 用户名唯一性检查
   - 保存到数据库
   - 自动跳转到登录

2. ✅ **用户登录**
   - 支持用户名/登录名登录
   - 密码验证
   - 用户信息存储
   - 权限设置
   - 记住密码

3. ✅ **错误处理**
   - 用户不存在
   - 密码错误
   - 用户名已存在
   - 表单验证错误

4. ✅ **用户体验**
   - 友好的错误提示
   - 自动跳转
   - 记住密码功能

### 后续优化建议

1. 🔐 密码加密（bcrypt）
2. 🎫 JWT Token 认证
3. 🛡️ CSRF 保护
4. 🚫 防暴力破解
5. 📧 邮箱验证
6. 🔑 找回密码功能
7. 👤 用户资料完善

---

## 🎯 使用说明

**现在您可以：**

1. **注册新账号**
   - 访问：`http://localhost:5173/register`
   - 填写用户名、密码、邮箱
   - 注册成功后会保存到数据库

2. **使用账号登录**
   - 访问：`http://localhost:5173/login`
   - 使用注册的账号或已有账号登录
   - 登录成功后进入系统

3. **权限控制**
   - `管理员`/`super_admin`：完整权限
   - `普通用户`：受限权限

**测试账号（已存在）：**
- 用户名：`admin`
- 密码：`123456`
- 角色：超级管理员

**立即测试吧！** 🚀
