# 全面数据库字段检查说明

## 概述

为了确保在不同环境下数据库字段的完整性，系统提供了全面的数据库字段检查功能，可以检查所有表的字段是否与代码中的模型定义一致。

## 功能特点

1. **全面检查**：检查所有主要表的字段完整性
2. **自动修复**：自动添加缺失的字段
3. **智能识别**：识别多余字段但不删除
4. **详细报告**：提供完整的检查报告

## 检查的表和字段

### 1. tb_user (用户表)
- **基础字段**：id, name, login_name, password, sex, department, role
- **新增字段**：email, phone, signature
- **时间字段**：create_time, update_time

### 2. tb_task_info (任务信息表)
- **任务字段**：task_name, project, task_code, undertake, participant
- **人员字段**：ship, leader, chief_scientist, superintendent, superintended
- **其他字段**：executiontime, subject, user_id

### 3. tb_expert_talent (专家人才表)
- **基本信息**：name, gender, birth_date, job_title, work_unit
- **专业信息**：specialty, contact_info, id_number
- **财务信息**：bank_card_number, opening_bank
- **其他字段**：remarks, user_id, create_time, update_time

### 4. tb_task_unit (任务单位表)
- **单位信息**：unit_name, specialized_person, quality_manager
- **联系信息**：contact_person, contact_info
- **其他字段**：remarks, user_id, create_time, update_time

### 5. tb_onboard_inspection (随船检查表)
- **基本信息**：task_name, inspected_unit, participating_unit, task_code
- **人员信息**：chief_scientist, onboard_supervisor, inspected_unit_personnel
- **检查项目**：check_1 到 check_12 及其对应的 problem 字段
- **签名信息**：team_leader_sign, task_leader_sign
- **其他字段**：attachments, user_id, create_time, update_time

## 使用方法

### 1. 自动执行（推荐）

在 `backend/app.py` 中启用全面检查：

```python
# 全面检查所有表字段（可选，根据需要启用）
with app.app_context():
    from check_all_tables_fields import run_comprehensive_check
    run_comprehensive_check()
```

### 2. 手动执行

```bash
cd backend
python check_all_tables_fields.py
```

### 3. 单独检查用户表

```bash
cd backend
python auto_migrate_user_fields.py
```

## 输出示例

### 正常检查结果
```
开始全面数据库字段检查...
开始检查所有数据库表字段...
============================================================

检查表: tb_user
----------------------------------------
所有必需字段都存在
没有额外字段

检查表: tb_task_info
----------------------------------------
所有必需字段都存在
没有额外字段

数据库字段检查完成!
统计信息:
   - 缺失字段: 0
   - 成功添加: 0
   - 额外字段: 0
数据库字段检查完成
```

### 发现缺失字段
```
开始全面数据库字段检查...
开始检查所有数据库表字段...
============================================================

检查表: tb_user
----------------------------------------
发现 2 个缺失字段:
   - create_time (datetime)
   字段 create_time 添加成功
   - update_time (datetime)
   字段 update_time 添加成功
发现 2 个额外字段:
   - desc (varchar)
   - permission (varchar)

数据库字段检查完成!
统计信息:
   - 缺失字段: 2
   - 成功添加: 2
   - 额外字段: 2
数据库字段检查完成
```

## 配置说明

### 启用全面检查

在 `backend/app.py` 中取消注释：

```python
# 全面检查所有表字段（可选，根据需要启用）
with app.app_context():
    from check_all_tables_fields import run_comprehensive_check
    run_comprehensive_check()
```

### 只启用用户表检查

保持当前配置，只检查用户表字段：

```python
# 自动检查并添加用户表缺失字段
with app.app_context():
    from auto_migrate_user_fields import run_migration
    run_migration()
```

## 注意事项

1. **数据库权限**：确保数据库用户有 `ALTER TABLE` 权限
2. **备份建议**：在生产环境执行前建议备份数据库
3. **字段类型**：脚本会根据模型定义自动设置正确的字段类型
4. **多余字段**：脚本会报告多余字段但不会删除，需要手动处理
5. **性能影响**：全面检查会检查所有表，首次运行可能需要一些时间

## 故障排除

### 常见问题

1. **权限不足**：确保数据库用户有足够的权限
2. **字段冲突**：如果字段已存在但类型不同，需要手动处理
3. **编码问题**：确保数据库和系统使用相同的字符编码

### 日志查看

检查过程的详细信息会输出到控制台，包括：
- 每个表的检查结果
- 缺失字段的添加状态
- 统计信息汇总

## 扩展说明

### 添加新表检查

在 `check_all_tables_fields.py` 的 `get_expected_fields()` 函数中添加新表：

```python
expected_fields = {
    # 现有表...
    'tb_new_table': [
        {'name': 'id', 'type': 'int', 'nullable': False},
        {'name': 'name', 'type': 'varchar', 'length': 100, 'nullable': False},
        # 更多字段...
    ]
}
```

### 修改字段定义

在 `get_expected_fields()` 函数中修改字段定义：

```python
'tb_user': [
    # 现有字段...
    {'name': 'new_field', 'type': 'varchar', 'length': 50, 'nullable': True},
]
```

## 版本历史

- **v1.0** (2024-10-03): 初始版本，支持主要表的字段检查
- **v1.1** (2024-10-03): 添加用户表专用检查脚本
- **v1.2** (2024-10-03): 完善全面检查功能，支持所有主要表
