# 数据库说明文档

## 📊 数据库基本信息

- **数据库名称**: `marine_survey_db`
- **字符集**: `utf8mb4`
- **总表数**: 10 张
- **备份文件**: `marine_survey_db_latest.sql`
- **最后更新**: 2025-09-30

---

## 📋 数据表清单

### 1. 用户相关表

#### `tb_user` - 用户表
**功能**: 存储系统用户信息，支持用户隔离

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| `id` | INT | 用户ID（主键） | 自增, 主键 |
| `name` | VARCHAR(45) | 用户名 | 唯一, 非空 |
| `login_name` | VARCHAR(45) | 登录名 | - |
| `password` | VARCHAR(45) | 密码 | - |
| `sex` | VARCHAR(45) | 性别 | - |
| `role` | VARCHAR(45) | 角色 | - |
| `desc` | VARCHAR(45) | 描述 | - |
| `permission` | VARCHAR(45) | 权限 | - |
| `department` | VARCHAR(255) | 部门 | 非空 |

**初始数据**:
- ID=1: 111 (测试用户)
- ID=2: 12
- ID=3: 123 (普通用户)
- ID=4: admin (超级管理员)
- ID=12: 1234 (新用户)

**重要**: 
- `id` 是自增主键，用于用户隔离
- 所有现有任务默认关联到 `user_id=3` (用户123)

---

### 2. 任务相关表

#### `tb_task_info` - 任务信息表
**功能**: 存储航次任务的基本信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| `task_name` | VARCHAR(100) | 任务名称 | 主键 |
| `task_code` | VARCHAR(100) | 任务编号 | - |
| `project` | VARCHAR(100) | 专项名称 | - |
| `undertake` | VARCHAR(100) | 承担单位 | - |
| `participant` | VARCHAR(200) | 参与单位 | - |
| `ship` | VARCHAR(45) | 调查船 | - |
| `leader` | VARCHAR(45) | 任务负责人 | - |
| `chief_scientist` | VARCHAR(45) | 首席科学家 | - |
| `superintendent` | VARCHAR(100) | 随船监督员 | - |
| `superintended` | VARCHAR(45) | 随船监督 | - |
| `executiontime` | TEXT | 执行时间 | - |
| `subject` | VARCHAR(45) | 任务学科 | - |
| **`user_id`** | **INT** | **创建用户ID** | **默认3** |

**用户隔离**:
- `user_id` 关联到 `tb_user.id`
- 每个用户只能看到自己创建的任务
- 现有任务的 `user_id=3`

#### `tb_task_hqzljdjcjlb` - 航前质量监督检查记录表
**功能**: 存储航前检查的详细记录

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| `task_name` | VARCHAR(100) | 任务名称（外键） | 主键 |
| `check_date` | DATE | 检查日期 | - |
| `superintendent` | VARCHAR(100) | 监督员 | - |
| `superintended` | VARCHAR(100) | 被监督方 | - |
| `check_1` ~ `check_11` | TEXT | 检查内容1~11 | - |
| `check_1_problem` ~ `check_11_problem` | TEXT | 存在问题1~11 | - |
| `check_detail` | TEXT | 检查详情 | - |
| `check_result` | TEXT | 检查结果 | - |
| `chief_scientist_sign` | VARCHAR(45) | 首席科学家签字 | - |
| `check_leader_sign` | VARCHAR(45) | 检查负责人签字 | - |
| `chief_scientist_signdate` | DATE | 首席科学家签字日期 | - |
| `check_leader_signdate` | DATE | 检查负责人签字日期 | - |
| **`user_id`** | **INT** | **创建用户ID** | **默认3** |

**检查项说明**:
1. 检查内容1: 任务来源及下达的批复性文件（任务通知书、任务书）
2. 检查内容2: 任务设计书、实施方案、技术规程、质量要求等
3. 检查内容3: 仪器设备配置及检定/校准
4. 检查内容4: 调查人员资质及岗前培训
5. 检查内容5: 任务各阶段工作及进度、成果计划安排
6. 检查内容6: 站位布设
7. 检查内容7: 调查船舶及调查平台使用
8. 检查内容8: 应急预案
9. 检查内容9: 环保和安全措施
10. 检查内容10: 外协分包
11. 检查内容11: 任务数据汇交计划

#### `tb_task_sczljdjcb` - 生产质量监督检查表
**功能**: 存储生产过程中的质量检查记录

#### `tb_task_zlpgb` - 质量评估表
**功能**: 存储任务质量评估信息

---

### 3. 基础信息表

#### `tb_base_master` - 基本人员信息表
**功能**: 存储项目相关人员的基本信息

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| `id_card_number` | VARCHAR(45) | 身份证号 | 主键 |
| `name` | VARCHAR(100) | 姓名 | - |
| `sex` | VARCHAR(10) | 性别 | - |
| `birth_date` | DATE | 出生日期 | - |
| `education` | VARCHAR(100) | 学历 | - |
| `major` | VARCHAR(100) | 专业 | - |
| `work_unit` | VARCHAR(200) | 工作单位 | - |
| `job_title` | VARCHAR(100) | 职称 | - |
| `phone_number` | VARCHAR(45) | 电话 | - |
| `email` | VARCHAR(100) | 邮箱 | - |
| `address` | VARCHAR(255) | 地址 | - |
| **`user_id`** | **INT** | **创建用户ID** | **默认3** |

#### `tb_base_hq_investigator` - 航前调查人员表
**功能**: 存储航前调查人员信息

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `uniqueid` | VARCHAR(100) | 唯一ID（主键） |
| `task_name` | VARCHAR(100) | 任务名称 |
| `task_code` | VARCHAR(100) | 任务编号 |
| `ship` | VARCHAR(100) | 调查船 |
| `name` | VARCHAR(40) | 姓名 |
| `sex` | VARCHAR(4) | 性别 |
| `birthday` | DATE | 出生日期 |
| `title` | VARCHAR(40) | 职称 |
| `organization` | VARCHAR(45) | 所属单位 |
| `major` | VARCHAR(45) | 专业 |
| `instrument` | VARCHAR(45) | 仪器设备 |
| `trainingdate` | VARCHAR(45) | 培训日期 |
| `remark` | VARCHAR(100) | 备注 |
| `preparer` | VARCHAR(45) | 编制人 |
| `verifier` | VARCHAR(45) | 审核人 |
| `create_date` | DATE | 创建日期 |
| `attachment` | TEXT | 附件 |

#### `tb_base_hz_investigator` - 航中调查人员表
**功能**: 存储航中调查人员信息（结构同 `tb_base_hq_investigator`）

#### `tb_base_hq_device` - 航前设备表
**功能**: 存储航前使用的设备信息

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `uniqueid` | VARCHAR(100) | 唯一ID（主键） |
| `task_name` | VARCHAR(100) | 任务名称 |
| `type` | VARCHAR(45) | 设备类型 |
| `name` | VARCHAR(100) | 设备名称 |
| `id` | VARCHAR(45) | 设备编号 |
| `model` | VARCHAR(45) | 型号 |
| `traceability` | VARCHAR(45) | 溯源性 |
| `checkdate` | DATE | 检定日期 |
| `certificate_number` | VARCHAR(45) | 证书编号 |
| `validity` | VARCHAR(45) | 有效期 |
| `verification_institutions` | VARCHAR(45) | 检定机构 |
| `remark` | VARCHAR(100) | 备注 |
| `attachment` | TEXT | 附件 |
| `preparer` | VARCHAR(45) | 编制人 |
| `verifier` | VARCHAR(45) | 审核人 |
| `create_date` | DATE | 创建日期 |

#### `tb_base_hz_device` - 航中设备表
**功能**: 存储航中使用的设备信息（结构同 `tb_base_hq_device`）

---

## 🔑 用户隔离机制

### 核心字段
以下表包含 `user_id` 字段，实现用户隔离：
- ✅ `tb_task_info`
- ✅ `tb_task_hqzljdjcjlb`
- ✅ `tb_base_master`

### 隔离逻辑
1. **用户登录**：返回 `user.id`
2. **查询数据**：根据 `user_id` 过滤（`WHERE user_id = ?`）
3. **创建数据**：自动关联当前用户的 `user_id`
4. **禁止修改**：`user_id` 字段不可编辑

### 现有数据
- 所有现有任务/检查记录/人员信息：`user_id = 3`
- 用户ID=3 对应用户名：`123`

---

## 🗂️ 表关系说明

### 主要关联
1. **任务 ↔ 检查记录**（一对一）
   - `tb_task_info.task_name` → `tb_task_hqzljdjcjlb.task_name`

2. **任务 ↔ 人员**（一对多）
   - `tb_task_info.task_name` → `tb_base_hq_investigator.task_name`
   - `tb_task_info.task_name` → `tb_base_hz_investigator.task_name`

3. **任务 ↔ 设备**（一对多）
   - `tb_task_info.task_name` → `tb_base_hq_device.task_name`
   - `tb_task_info.task_name` → `tb_base_hz_device.task_name`

4. **用户 ↔ 任务**（一对多）
   - `tb_user.id` → `tb_task_info.user_id`

---

## 📥 如何使用 SQL 文件

### 1. 完整导入（全新数据库）
```bash
mysql -u root -p
CREATE DATABASE marine_survey_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
exit

mysql -u root -p marine_survey_db < marine_survey_db_latest.sql
```

### 2. 更新现有数据库
```bash
# 备份现有数据库
mysqldump -u root -p marine_survey_db > backup_old.sql

# 导入新结构和数据
mysql -u root -p marine_survey_db < marine_survey_db_latest.sql
```

### 3. 使用 Python 导入
```python
import pymysql
import os

conn = pymysql.connect(
    host='localhost',
    user='root',
    password='your_password',
    database='marine_survey_db'
)

with open('marine_survey_db_latest.sql', 'r', encoding='utf-8') as f:
    sql_commands = f.read().split(';')
    
cur = conn.cursor()
for command in sql_commands:
    if command.strip():
        cur.execute(command)

conn.commit()
cur.close()
conn.close()
```

---

## 🔄 数据迁移检查清单

### 导入前检查
- [ ] 备份现有数据库
- [ ] 确认 MySQL 版本兼容（推荐 8.0+）
- [ ] 确认字符集为 `utf8mb4`

### 导入后验证
- [ ] 检查表数量（应为 10 张表）
- [ ] 验证 `tb_user` 表有自增主键 `id`
- [ ] 验证 `tb_task_info` 等表有 `user_id` 字段
- [ ] 检查初始用户数据（至少 4 个用户）
- [ ] 验证任务数据的 `user_id` 默认值

### SQL 验证查询
```sql
-- 检查表数量
SELECT COUNT(*) FROM information_schema.tables 
WHERE table_schema = 'marine_survey_db';

-- 检查 tb_user 结构
DESCRIBE tb_user;

-- 检查用户数据
SELECT id, name, role FROM tb_user;

-- 检查任务的 user_id
SELECT task_name, user_id FROM tb_task_info;

-- 检查检查记录的 user_id
SELECT task_name, user_id FROM tb_task_hqzljdjcjlb;
```

---

## 📝 重要注意事项

### 1. 主键变更
- ⚠️ `tb_user` 的主键从 `name` 改为 `id`
- ⚠️ `name` 字段现在是唯一索引，不再是主键
- ⚠️ 所有通过 `name` 查询用户的代码需要更新

### 2. 用户隔离
- ✅ `user_id` 字段已添加到关键表
- ✅ 现有数据默认 `user_id=3`
- ✅ 新数据自动关联当前登录用户

### 3. 数据一致性
- 创建任务时，自动创建对应的检查记录
- 删除任务时，自动删除对应的检查记录
- 两者的 `user_id` 保持一致

---

**文档更新时间**: 2025-09-30  
**对应 SQL 文件**: `marine_survey_db_latest.sql`  
**备注**: 此 SQL 文件包含用户隔离功能的完整数据库结构
