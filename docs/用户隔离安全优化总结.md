# ç”¨æˆ·éš”ç¦»åŠŸèƒ½å®‰å…¨ä¼˜åŒ–æ€»ç»“

## 1. ğŸ” å®‰å…¨é—®é¢˜åˆ†æ

### 1.1 âŒ åŸæœ‰æ–¹æ¡ˆçš„å®‰å…¨éšæ‚£

**é—®é¢˜1ï¼šç”¨æˆ·å¯ä»¥ä¼ªé€ èº«ä»½æŸ¥çœ‹å…¶ä»–äººçš„æ•°æ®**
```javascript
// æ”»å‡»è€…å¯ä»¥åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š
localStorage.setItem('userId', '3');  // ä¼ªè£…æˆç”¨æˆ·ID=3
// ç„¶ååˆ·æ–°é¡µé¢ï¼Œå°±èƒ½çœ‹åˆ°ç”¨æˆ·3çš„æ‰€æœ‰æ•°æ®
```

**é—®é¢˜2ï¼šç”¨æˆ·å¯ä»¥ä¿®æ”¹è¯·æ±‚å‚æ•°çªƒå–æ•°æ®**
```javascript
// æ”»å‡»è€…å¯ä»¥åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¿®æ”¹è¯·æ±‚ï¼š
GET /api/tasks?user_id=1  // æŸ¥çœ‹ç”¨æˆ·1çš„ä»»åŠ¡
GET /api/tasks?user_id=2  // æŸ¥çœ‹ç”¨æˆ·2çš„ä»»åŠ¡
```

**é—®é¢˜3ï¼šç”¨æˆ·å¯ä»¥åˆ›å»ºæ•°æ®åˆ°å…¶ä»–äººåä¸‹**
```javascript
// æ”»å‡»è€…åˆ›å»ºä»»åŠ¡æ—¶æŒ‡å®šåˆ«äººçš„IDï¼š
{
  "task_name": "æ¶æ„ä»»åŠ¡",
  "user_id": 3  // è®©ç³»ç»Ÿè®¤ä¸ºæ˜¯ç”¨æˆ·3åˆ›å»ºçš„
}
```

### 1.2 ğŸ”´ ä¸ºä»€ä¹ˆåŸæœ‰æ–¹æ¡ˆä¸å®‰å…¨ï¼Ÿ

åŸæœ‰æ–¹æ¡ˆçš„æ ¸å¿ƒé—®é¢˜ï¼š**åç«¯ä¿¡ä»»å‰ç«¯ä¼ é€’çš„ç”¨æˆ·ID**

```python
# âŒ ä¸å®‰å…¨çš„åšæ³•
@task_bp.route('/tasks', methods=['GET'])
def get_tasks():
    user_id = request.args.get('user_id')  # ä»è¯·æ±‚å‚æ•°è·å–
    tasks = TaskInfo.query.filter_by(user_id=int(user_id)).all()
    return jsonify(tasks)
```

å‰ç«¯å¯ä»¥éšæ„ä¿®æ”¹ `user_id` å‚æ•°ï¼Œåç«¯æ— æ³•éªŒè¯çœŸå®æ€§ï¼

---

## 2. âœ… JWT è®¤è¯æ–¹æ¡ˆï¼ˆå·²å®ç°ï¼‰

### 2.1 æ ¸å¿ƒåŸç†

1. **ç™»å½•æ—¶ç”Ÿæˆ Token**
   - ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œåç«¯ç”ŸæˆåŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ JWT token
   - Token ä½¿ç”¨å¯†é’¥ç­¾åï¼Œå‰ç«¯æ— æ³•ä¼ªé€ 

2. **è¯·æ±‚æ—¶éªŒè¯ Token**
   - å‰ç«¯æ¯æ¬¡è¯·æ±‚æ—¶æºå¸¦ token
   - åç«¯éªŒè¯ token çš„ç­¾åå’Œæœ‰æ•ˆæœŸ
   - ä» token ä¸­æå–ç”¨æˆ·IDï¼Œ**ä¸å†ä¿¡ä»»å‰ç«¯å‚æ•°**

3. **æƒé™æ§åˆ¶**
   - æ™®é€šç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®
   - ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æ•°æ®

---

## 3. ğŸ“‹ å®ç°æ­¥éª¤

### 3.1 åç«¯å®ç°

#### 3.1.1 å®‰è£…ä¾èµ–
```bash
pip install PyJWT==2.8.0
```

#### 3.1.2 åˆ›å»º JWT å·¥å…·å‡½æ•°
**æ–‡ä»¶ï¼š`backend/utils/jwt_utils.py`**
```python
import jwt
from datetime import datetime, timedelta
from functools import wraps
from flask import request, jsonify

SECRET_KEY = 'your-secret-key-change-in-production'
ALGORITHM = 'HS256'
TOKEN_EXPIRATION_HOURS = 24

def generate_token(user_id: int, username: str, role: str) -> str:
    """ç”Ÿæˆ JWT token"""
    payload = {
        'user_id': user_id,
        'username': username,
        'role': role,
        'exp': datetime.utcnow() + timedelta(hours=TOKEN_EXPIRATION_HOURS),
        'iat': datetime.utcnow()
    }
    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)

def verify_token(token: str) -> dict:
    """éªŒè¯ JWT token"""
    try:
        return jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
    except jwt.ExpiredSignatureError:
        raise jwt.ExpiredSignatureError('Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
    except jwt.InvalidTokenError:
        raise jwt.InvalidTokenError('Tokenæ— æ•ˆ')

def token_required(f):
    """è£…é¥°å™¨ï¼šè¦æ±‚è¯·æ±‚å¿…é¡»æºå¸¦æœ‰æ•ˆçš„ token"""
    @wraps(f)
    def decorated(*args, **kwargs):
        token = None
        
        # ä»è¯·æ±‚å¤´è·å– token
        if 'Authorization' in request.headers:
            auth_header = request.headers['Authorization']
            try:
                token = auth_header.split(' ')[1]  # æ ¼å¼ï¼šBearer <token>
            except IndexError:
                return jsonify({'code': 401, 'message': 'Tokenæ ¼å¼é”™è¯¯'}), 401
        
        if not token:
            return jsonify({'code': 401, 'message': 'æœªæä¾›Tokenï¼Œè¯·å…ˆç™»å½•'}), 401
        
        try:
            current_user = verify_token(token)
            return f(current_user, *args, **kwargs)
        except jwt.ExpiredSignatureError:
            return jsonify({'code': 401, 'message': 'Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'}), 401
        except jwt.InvalidTokenError:
            return jsonify({'code': 401, 'message': 'Tokenæ— æ•ˆ'}), 401
    
    return decorated
```

#### 3.1.3 æ›´æ–°ç™»å½•æ¥å£
**æ–‡ä»¶ï¼š`backend/controllers/auth_controller.py`**
```python
from utils.jwt_utils import generate_token

@auth_bp.route('/login', methods=['POST'])
def login():
    # ... éªŒè¯ç”¨æˆ·åå¯†ç  ...
    
    # âœ… ç”Ÿæˆ JWT token
    token = generate_token(user.id, user.name, user.role)
    
    return jsonify({
        'code': 200,
        'message': 'ç™»å½•æˆåŠŸ',
        'data': {
            'id': user.id,
            'username': user.name,
            'role': user.role,
            'token': token  # è¿”å› token
        }
    })
```

#### 3.1.4 æ›´æ–°ä»»åŠ¡æ¥å£ï¼ˆä½¿ç”¨ JWT è®¤è¯ï¼‰
**æ–‡ä»¶ï¼š`backend/controllers/task_controller.py`**
```python
from utils.jwt_utils import token_required

@task_bp.route('/tasks', methods=['GET'])
@token_required  # â† æ·»åŠ è®¤è¯è£…é¥°å™¨
def get_tasks(current_user):  # â† è‡ªåŠ¨æ³¨å…¥ current_user
    # âœ… ä» token ä¸­è·å–ç”¨æˆ·IDï¼ˆå®‰å…¨ï¼Œæ— æ³•ä¼ªé€ ï¼‰
    user_id = current_user['user_id']
    user_role = current_user['role']
    
    # ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
    if user_role in ['super_admin', 'ç®¡ç†å‘˜']:
        tasks = TaskInfo.query.all()
    else:
        # æ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä»»åŠ¡
        tasks = TaskInfo.query.filter_by(user_id=user_id).all()
    
    return jsonify({...})

@task_bp.route('/tasks', methods=['POST'])
@token_required
def create_task(current_user):
    # âœ… ä½¿ç”¨ token ä¸­çš„ç”¨æˆ·IDï¼Œå¿½ç•¥å‰ç«¯ä¼ é€’çš„å‚æ•°
    user_id = current_user['user_id']
    
    new_task = TaskInfo(
        task_name=data.get('task_name'),
        user_id=user_id  # å¼ºåˆ¶ä½¿ç”¨ token ä¸­çš„ç”¨æˆ·ID
    )
    # ...

@task_bp.route('/tasks/<task_name>', methods=['PUT'])
@token_required
def update_task(current_user, task_name):
    task = db.session.get(TaskInfo, decoded_name)
    
    # âœ… æƒé™éªŒè¯ï¼šåªèƒ½ä¿®æ”¹è‡ªå·±çš„ä»»åŠ¡
    if task.user_id != current_user['user_id'] and current_user['role'] not in ['super_admin', 'ç®¡ç†å‘˜']:
        return jsonify({'code': 403, 'message': 'æ— æƒä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„ä»»åŠ¡'}), 403
    
    # ...
```

#### 3.1.5 æ›´æ–°æ£€æŸ¥è®°å½•æ¥å£ï¼ˆä½¿ç”¨ JWT è®¤è¯ï¼‰
**æ–‡ä»¶ï¼š`backend/controllers/inspection_controller.py`**
```python
from utils.jwt_utils import token_required

@inspection_bp.route('/inspections/task/<task_name>', methods=['GET'])
@token_required
def get_inspection_by_task(current_user, task_name):
    # âœ… éªŒè¯æƒé™
    if inspection.user_id != current_user['user_id'] and current_user['role'] not in ['super_admin', 'ç®¡ç†å‘˜']:
        return jsonify({'code': 403, 'message': 'æ— æƒæŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„æ£€æŸ¥è®°å½•'}), 403
    # ...

@inspection_bp.route('/inspections/<task_name>', methods=['PUT'])
@token_required
def update_inspection(current_user, task_name):
    # âœ… éªŒè¯æƒé™
    if inspection.user_id != current_user['user_id'] and current_user['role'] not in ['super_admin', 'ç®¡ç†å‘˜']:
        return jsonify({'code': 403, 'message': 'æ— æƒä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„æ£€æŸ¥è®°å½•'}), 403
    # ...
```

### 3.2 å‰ç«¯å®ç°

#### 3.2.1 æ›´æ–°è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨æºå¸¦ tokenï¼‰
**æ–‡ä»¶ï¼š`src/utils/request.ts`**
```typescript
service.interceptors.request.use(
    (config: InternalAxiosRequestConfig) => {
        // âœ… è‡ªåŠ¨æ·»åŠ  token åˆ°è¯·æ±‚å¤´
        const token = localStorage.getItem('token');
        if (token && config.headers) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    },
    // ...
);

service.interceptors.response.use(
    // ...
    (error: AxiosError) => {
        // âœ… å¤„ç† token è¿‡æœŸ
        if (error.response?.status === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            window.location.href = '/#/login';
        }
        return Promise.reject(error);
    }
);
```

#### 3.2.2 ç™»å½•æ—¶ä¿å­˜ token
**æ–‡ä»¶ï¼š`src/views/pages/login.vue`**
```typescript
if (res.data.code === 200) {
    const userData = res.data.data;
    localStorage.setItem('token', userData.token);  // âœ… ä¿å­˜ token
    localStorage.setItem('userId', userData.id);
    // ...
}
```

#### 3.2.3 ç§»é™¤å‰ç«¯çš„ user_id å‚æ•°
**æ–‡ä»¶ï¼š`src/views/VoyageInfo/task-manage.vue`**
```typescript
// âŒ åŸæœ‰ä»£ç ï¼ˆä¸å®‰å…¨ï¼‰
const getData = async () => {
    const userId = localStorage.getItem('userId');
    const res = await fetchTasksNew({ user_id: userId });  // å‰ç«¯ä¼ é€’ user_id
    // ...
};

// âœ… æ–°ä»£ç ï¼ˆå®‰å…¨ï¼‰
const getData = async () => {
    // ä¸å†ä¼ é€’ user_idï¼Œåç«¯ä¼šä» token ä¸­è·å–
    const res = await fetchTasksNew({});
    // ...
};
```

---

## 4. ğŸ”’ å®‰å…¨å¯¹æ¯”

### 4.1 åŸæœ‰æ–¹æ¡ˆï¼ˆä¸å®‰å…¨ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯   â”‚ user_id=1 (å¯ä¼ªé€ ) â”‚  åç«¯   â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚         â”‚
â”‚         â”‚                    â”‚ ä¿¡ä»»å‰ç«¯â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           âŒ ç”¨æˆ·å¯ä»¥ä¿®æ”¹ user_id
```

### 4.2 JWT æ–¹æ¡ˆï¼ˆå®‰å…¨ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯   â”‚  Token (å·²ç­¾å)    â”‚  åç«¯   â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚         â”‚
â”‚         â”‚                    â”‚ éªŒè¯ç­¾åâ”‚
â”‚         â”‚                    â”‚ æå–ID  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           âœ… Token æ— æ³•ä¼ªé€ ï¼Œåç«¯ä¸ä¿¡ä»»å‰ç«¯å‚æ•°
```

---

## 5. ğŸš€ ä½¿ç”¨æŒ‡å—

### 5.1 å®‰è£…ä¾èµ–
```bash
cd backend
pip install -r requirements.txt
```

### 5.2 é‡å¯åç«¯
```bash
python app.py
```

### 3. æµ‹è¯•ç™»å½•
```bash
curl -X POST http://localhost:5000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"123","password":"123456"}'

# è¿”å›ï¼š
{
  "code": 200,
  "data": {
    "id": 3,
    "username": "123",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### 4. ä½¿ç”¨ token è®¿é—®æ¥å£
```bash
# âœ… æ­£ç¡®æ–¹å¼ï¼ˆæºå¸¦ tokenï¼‰
curl http://localhost:5000/api/tasks \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# âŒ é”™è¯¯æ–¹å¼ï¼ˆä¸æºå¸¦ tokenï¼‰
curl http://localhost:5000/api/tasks
# è¿”å›ï¼š{"code": 401, "message": "æœªæä¾›Tokenï¼Œè¯·å…ˆç™»å½•"}

# âŒ ä¼ªé€  user_idï¼ˆæ— æ•ˆï¼‰
curl http://localhost:5000/api/tasks?user_id=999 \
  -H "Authorization: Bearer <token>"
# åç«¯ä¼šå¿½ç•¥ user_id å‚æ•°ï¼Œä½¿ç”¨ token ä¸­çš„çœŸå®ç”¨æˆ·ID
```

---

## ğŸ¯ å®‰å…¨æ”¹è¿›æ€»ç»“

### âœ… è§£å†³çš„å®‰å…¨é—®é¢˜

1. **é˜²æ­¢èº«ä»½ä¼ªé€ **ï¼šç”¨æˆ·æ— æ³•é€šè¿‡ä¿®æ”¹ localStorage ä¼ªè£…æˆå…¶ä»–ç”¨æˆ·
2. **é˜²æ­¢å‚æ•°ç¯¡æ”¹**ï¼šç”¨æˆ·æ— æ³•é€šè¿‡ä¿®æ”¹è¯·æ±‚å‚æ•°è®¿é—®å…¶ä»–ç”¨æˆ·çš„æ•°æ®
3. **é˜²æ­¢æ•°æ®å½’å±ç¯¡æ”¹**ï¼šç”¨æˆ·æ— æ³•åˆ›å»ºæ•°æ®åˆ°å…¶ä»–ç”¨æˆ·åä¸‹
4. **è‡ªåŠ¨è¿‡æœŸæœºåˆ¶**ï¼šToken 24å°æ—¶è‡ªåŠ¨è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
5. **æƒé™æ§åˆ¶**ï¼šæ™®é€šç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®ï¼Œç®¡ç†å‘˜å¯ä»¥ç®¡ç†æ‰€æœ‰æ•°æ®

### ğŸ”’ å®‰å…¨ç‰¹æ€§

- âœ… **Token ç­¾åéªŒè¯**ï¼šåç«¯ä½¿ç”¨å¯†é’¥ç­¾åï¼Œå‰ç«¯æ— æ³•ä¼ªé€ 
- âœ… **è‡ªåŠ¨è¿‡æœŸ**ï¼šToken 24å°æ—¶åè‡ªåŠ¨å¤±æ•ˆ
- âœ… **ä¸ä¿¡ä»»å‰ç«¯**ï¼šåç«¯å®Œå…¨å¿½ç•¥å‰ç«¯ä¼ é€’çš„ user_idï¼Œåªä» token ä¸­æå–
- âœ… **æƒé™éªŒè¯**ï¼šæ¯ä¸ªæ“ä½œéƒ½ä¼šéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™
- âœ… **ç»Ÿä¸€è®¤è¯**ï¼šæ‰€æœ‰æ¥å£ç»Ÿä¸€ä½¿ç”¨ `@token_required` è£…é¥°å™¨

### ğŸ“ˆ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥**
   ```python
   import os
   SECRET_KEY = os.environ.get('JWT_SECRET_KEY', 'default-key')
   ```

2. **å®ç° Token åˆ·æ–°æœºåˆ¶**
   - å½“ token å¿«è¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°
   - é¿å…ç”¨æˆ·é¢‘ç¹ç™»å½•

3. **è®°å½•æ“ä½œæ—¥å¿—**
   - è®°å½•è°ã€ä»€ä¹ˆæ—¶å€™ã€åšäº†ä»€ä¹ˆæ“ä½œ
   - ä¾¿äºå®¡è®¡å’Œè¿½æº¯

4. **IP ç™½åå•**
   - é™åˆ¶åªèƒ½ä»ç‰¹å®š IP è®¿é—®æ•æ„Ÿæ¥å£

5. **å¯†ç åŠ å¯†**
   - ä½¿ç”¨ bcrypt æˆ– argon2 åŠ å¯†å­˜å‚¨å¯†ç 
   - å½“å‰å¯†ç æ˜¯æ˜æ–‡å­˜å‚¨ï¼Œä¸å®‰å…¨

---

**æ›´æ–°æ—¶é—´**ï¼š2025å¹´10æœˆ1æ—¥  
**å®‰å…¨çº§åˆ«**ï¼šâœ… é«˜ï¼ˆå·²å®ç° JWT è®¤è¯ï¼‰  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… åç«¯å·²å®ç°ï¼Œå‰ç«¯å·²é€‚é…  
**ä¸‹ä¸€æ­¥**ï¼šå®ç° token åˆ·æ–°æœºåˆ¶ã€å¯†ç åŠ å¯†

