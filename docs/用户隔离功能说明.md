# 用户隔离功能说明

## 📋 功能概述

实现用户隔离功能，让每个用户只能看到和管理自己创建的数据（任务、检查记录等）。

## 🔑 核心改动

### 1. 数据库表结构变更

#### `tb_user` 表
- ✅ 添加自增主键 `id`（原主键 `name` 改为唯一索引）
- **字段**：
  - `id` INT AUTO_INCREMENT PRIMARY KEY
  - `name` VARCHAR(45) UNIQUE NOT NULL

#### `tb_task_info` 表
- ✅ 添加 `user_id` 列
- **字段**：`user_id` INT NOT NULL DEFAULT 3 COMMENT '创建任务的用户ID'
- **关联**：关联到 `tb_user.id`

#### `tb_task_hqzljdjcjlb` 表
- ✅ 添加 `user_id` 列
- **字段**：`user_id` INT NOT NULL DEFAULT 3 COMMENT '创建检查记录的用户ID'

#### `tb_base_master` 表
- ✅ 添加 `user_id` 列
- **字段**：`user_id` INT NOT NULL DEFAULT 3 COMMENT '创建人员信息的用户ID'

### 2. Models 更新

#### `User` 模型
```python
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)  # 新主键
    name = db.Column(db.String(45), unique=True, nullable=False)     # 改为唯一索引
    # ... 其他字段
```

#### `TaskInfo` 模型
```python
class TaskInfo(db.Model):
    # ... 其他字段
    user_id = db.Column(db.Integer, nullable=False, comment='创建任务的用户ID')
```

#### `PreVoyageInspection` 模型
```python
class PreVoyageInspection(db.Model):
    # ... 其他字段
    user_id = db.Column(db.Integer, nullable=False, comment='创建检查记录的用户ID')
```

### 3. Controllers 更新

#### 用户控制器（`user_controller.py`）
- ✅ 更新查询方式（主键从 `name` 改为 `id`）
- ✅ 禁止修改 `id` 和 `name`

#### 认证控制器（`auth_controller.py`）
- ✅ 登录成功返回用户 `id`
```python
return jsonify({
    'code': 200,
    'data': {
        'id': user.id,          # ← 新增
        'username': user.name,
        'role': user.role,
        # ...
    }
})
```

#### 任务控制器（`task_controller.py`）
- ✅ **获取任务**：根据 `user_id` 过滤（用户隔离）
```python
@task_bp.route('/tasks', methods=['GET'])
def get_tasks():
    user_id = request.args.get('user_id') or request.headers.get('X-User-ID')
    if user_id:
        tasks = TaskInfo.query.filter_by(user_id=int(user_id)).all()
    else:
        tasks = TaskInfo.query.all()  # 向后兼容
```

- ✅ **创建任务**：自动关联当前用户
```python
@task_bp.route('/tasks', methods=['POST'])
def create_task():
    user_id = data.get('user_id') or request.headers.get('X-User-ID') or 3
    new_task = TaskInfo(
        # ... 其他字段
        user_id=int(user_id)  # ← 自动关联
    )
```

- ✅ **更新任务**：禁止修改 `user_id`
```python
for key, value in data.items():
    if key not in ['task_name', 'user_id'] and hasattr(task, key):
        setattr(task, key, value)
```

## 🔐 用户隔离逻辑

### 工作流程

1. **用户登录**
   - 用户输入账号密码
   - 后端验证成功，返回 `user.id`
   - 前端保存 `user.id` 到 localStorage 或 Vuex

2. **获取数据（隔离）**
   - 前端发送请求时携带 `user_id` 参数或请求头
   - 后端根据 `user_id` 过滤数据
   - 只返回该用户创建的数据

3. **创建数据（自动关联）**
   - 前端创建数据时发送 `user_id`
   - 后端自动将 `user_id` 关联到新数据
   - 用户只能看到自己创建的数据

4. **更新数据（禁止转移）**
   - `user_id` 字段不可编辑
   - 用户1创建的任务不能改成用户2创建的

### 数据隔离示例

#### 用户1（id=1）创建任务
```json
{
  "task_name": "任务A",
  "project": "项目A",
  "user_id": 1  // 自动关联到用户1
}
```

#### 用户1查询任务
```bash
GET /api/tasks?user_id=1
# 只返回 user_id=1 的任务
```

#### 用户2（id=2）查询任务
```bash
GET /api/tasks?user_id=2
# 只返回 user_id=2 的任务（看不到用户1的任务）
```

## 📊 现有数据处理

### 初始数据设置
- ✅ 所有现有任务：`user_id = 3`（ID为3的用户）
- ✅ 所有现有检查记录：`user_id = 3`
- ✅ 所有现有人员信息：`user_id = 3`

### 用户列表示例
| ID | Name | Login | Role |
|----|------|-------|------|
| 1 | 111 | test | 111 |
| 2 | 12 | 12 | 12 |
| 3 | 123 | 123 | 普通用户 |
| 4 | admin | admin | super_admin |
| 5 | newuser | newuser | 普通用户 |

**注意**：ID=3 的用户（123）拥有所有现有数据。

## 🔨 前端需要的修改

### 1. 登录后保存用户ID
```javascript
// login.vue
const login = async () => {
  const res = await loginUser(formData);
  if (res.data.code === 200) {
    const userId = res.data.data.id;  // ← 获取用户ID
    localStorage.setItem('userId', userId);
    localStorage.setItem('username', res.data.data.username);
    router.push('/dashboard');
  }
};
```

### 2. 获取任务时携带 user_id
```javascript
// task-manage.vue
const getData = () => {
  const userId = localStorage.getItem('userId');
  fetchTasks({ user_id: userId }).then(res => {  // ← 携带 user_id
    tableData.value = res.data.data.list;
  });
};
```

### 3. 创建任务时携带 user_id
```javascript
// task-manage.vue
const saveEdit = () => {
  const userId = localStorage.getItem('userId');
  const data = {
    ...formData.value,
    user_id: userId  // ← 携带 user_id
  };
  createTask(data).then(/* ... */);
};
```

### 4. 表单选项中禁用 user_id
```javascript
// task-manage.vue
const options = computed(() => {
  return [
    // ... 其他字段
    {
      label: '创建用户ID',
      prop: 'user_id',
      type: 'number',
      disabled: true,  // ← 禁止编辑
      visible: false   // ← 或者直接隐藏
    }
  ];
});
```

## 📡 API 接口说明

### 用户管理

#### GET /api/users
- **返回**：包含 `id` 字段的用户列表
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": 1,
        "name": "111",
        "login_name": "test",
        ...
      }
    ]
  }
}
```

#### POST /api/login
- **返回**：包含 `id` 字段
```json
{
  "code": 200,
  "data": {
    "id": 1,          // ← 用户ID
    "username": "111",
    "role": "111",
    ...
  }
}
```

### 任务管理

#### GET /api/tasks?user_id=1
- **参数**：`user_id` （可选，推荐）
- **返回**：该用户的任务列表
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "task_name": "任务A",
        "user_id": 1,
        ...
      }
    ]
  }
}
```

#### POST /api/tasks
- **请求体**：包含 `user_id`
```json
{
  "task_name": "新任务",
  "project": "项目A",
  "user_id": 1,  // ← 当前用户ID
  ...
}
```

#### PUT /api/tasks/<task_name>
- **请求体**：`user_id` 不可修改（会被忽略）

## 🧪 测试步骤

### 1. 测试数据库结构
```bash
cd backend
python update_database_structure.py
```

### 2. 测试后端
```bash
# 启动后端
cd backend
python app.py

# 测试用户登录
curl -X POST http://localhost:5000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"123","password":"123456"}'
# 应返回：{"code": 200, "data": {"id": 3, ...}}

# 测试用户隔离
curl "http://localhost:5000/api/tasks?user_id=3"
# 应只返回 user_id=3 的任务
```

### 3. 测试前端
1. **登录**：使用 ID=3 的用户（123/123456）
2. **查看任务**：应该能看到所有现有任务（因为它们的 user_id 都是 3）
3. **创建新任务**：应该自动关联到当前用户（ID=3）
4. **切换用户**：登录 ID=1 的用户，应该看不到 ID=3 的任务

## ⚠️ 注意事项

### 1. 主键变更影响
- `tb_user` 的主键从 `name` 改为 `id`
- 所有通过 `name` 查询用户的地方需要改为 `filter_by(name=...)`

### 2. user_id 不可编辑
- `user_id` 是自动关联的，不允许手动修改
- 前端应禁用或隐藏 `user_id` 字段

### 3. 向后兼容
- 如果前端不传 `user_id`，后端返回所有数据（向后兼容）
- 建议前端尽快适配，传递 `user_id` 参数

### 4. 管理员权限
- 目前没有区分管理员和普通用户
- 如需管理员查看所有数据，可在后端添加权限判断：
  ```python
  if user.role == 'super_admin':
      tasks = TaskInfo.query.all()  # 管理员看所有
  else:
      tasks = TaskInfo.query.filter_by(user_id=user.id).all()  # 普通用户只看自己的
  ```

## 📈 后续优化建议

### 1. 添加外键约束
```sql
ALTER TABLE tb_task_info 
ADD CONSTRAINT fk_task_user 
FOREIGN KEY (user_id) REFERENCES tb_user(id) ON DELETE CASCADE;
```

### 2. 添加索引
```sql
CREATE INDEX idx_task_user_id ON tb_task_info(user_id);
CREATE INDEX idx_inspection_user_id ON tb_task_hqzljdjcjlb(user_id);
```

### 3. 使用 JWT 或 Session
- 不在请求中传递 `user_id`（不安全）
- 使用 JWT token 或 Session 存储用户信息
- 后端从 token/session 中获取 `user_id`

### 4. 权限系统
- 实现 RBAC（基于角色的访问控制）
- 管理员可查看/管理所有数据
- 普通用户只能查看/管理自己的数据

---

**更新时间**：2025年9月30日  
**数据库脚本**：`backend/update_database_structure.py`  
**测试状态**：✅ 数据库结构更新完成，Models 已更新，Controllers 已更新  
**前端适配**：⏳ 待前端修改
