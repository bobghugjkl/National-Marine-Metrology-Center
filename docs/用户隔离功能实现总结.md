# ç”¨æˆ·éš”ç¦»åŠŸèƒ½å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“ç»“æ„æ›´æ–° âœ“

#### æ‰§è¡Œçš„ SQL å˜æ›´
```sql
-- tb_user è¡¨ï¼šæ·»åŠ è‡ªå¢ä¸»é”® id
ALTER TABLE tb_user ADD COLUMN id INT AUTO_INCREMENT PRIMARY KEY FIRST;
ALTER TABLE tb_user ADD UNIQUE KEY unique_name (name);

-- tb_task_info è¡¨ï¼šæ·»åŠ  user_id åˆ—
ALTER TABLE tb_task_info ADD COLUMN user_id INT DEFAULT 3;

-- tb_task_hqzljdjcjlb è¡¨ï¼šæ·»åŠ  user_id åˆ—
ALTER TABLE tb_task_hqzljdjcjlb ADD COLUMN user_id INT DEFAULT 3;

-- tb_base_master è¡¨ï¼šæ·»åŠ  user_id åˆ—
ALTER TABLE tb_base_master ADD COLUMN user_id INT DEFAULT 3;
```

#### éªŒè¯ç»“æœ
```
[OK] tb_user è¡¨ç»“æ„:
  - id (INT, PRI, AUTO_INCREMENT)  â† æ–°çš„ä¸»é”®
  - name (VARCHAR, UNI)            â† æ”¹ä¸ºå”¯ä¸€ç´¢å¼•
  - ... å…¶ä»–å­—æ®µ

ç”¨æˆ·æ•°æ®ç¤ºä¾‹:
  ID: 1, Name: 111
  ID: 2, Name: 12
  ID: 3, Name: 123  â† ç°æœ‰æ•°æ®çš„é»˜è®¤æ‰€æœ‰è€…
  ID: 4, Name: admin
  ID: 5, Name: newuser
```

### 2. Models æ›´æ–° âœ“

#### æ›´æ–°çš„æ¨¡å‹æ–‡ä»¶

**`models/user.py`**
```python
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)  # æ–°ä¸»é”®
    name = db.Column(db.String(45), unique=True, nullable=False)      # å”¯ä¸€ç´¢å¼•
    # ...
    
    def to_dict(self):
        return {
            'id': self.id,  # â† æ–°å¢è¿”å› id
            # ...
        }
```

**`models/task.py`**
```python
class TaskInfo(db.Model):
    # ...
    user_id = db.Column(db.Integer, nullable=False, comment='åˆ›å»ºä»»åŠ¡çš„ç”¨æˆ·ID')
    
    def to_dict(self):
        return {
            # ...
            'user_id': self.user_id  # â† æ–°å¢è¿”å› user_id
        }
```

**`models/inspection.py`** å’Œ **`models/master.py`** åŒæ ·æ›´æ–°

### 3. Controllers æ›´æ–° âœ“

#### ç”¨æˆ·æ§åˆ¶å™¨ï¼ˆ`controllers/user_controller.py`ï¼‰

**å…³é”®ä¿®æ”¹**ï¼š
```python
# PUT /users/<name>
user = User.query.filter_by(name=decoded_name).first()  # æ”¹ç”¨ name æŸ¥è¯¢
for key, value in data.items():
    if key not in ['name', 'id'] and hasattr(user, key):  # ç¦æ­¢ä¿®æ”¹ id å’Œ name
        setattr(user, key, value)
```

#### è®¤è¯æ§åˆ¶å™¨ï¼ˆ`controllers/auth_controller.py`ï¼‰

**å…³é”®ä¿®æ”¹**ï¼š
```python
# POST /api/login
return jsonify({
    'code': 200,
    'data': {
        'id': user.id,  # â† è¿”å›ç”¨æˆ· ID
        'username': user.name,
        # ...
    }
})
```

#### ä»»åŠ¡æ§åˆ¶å™¨ï¼ˆ`controllers/task_controller.py`ï¼‰

**å…³é”®ä¿®æ”¹**ï¼š

1. **è·å–ä»»åŠ¡ï¼ˆç”¨æˆ·éš”ç¦»ï¼‰**ï¼š
```python
# GET /api/tasks?user_id=3
user_id = request.args.get('user_id') or request.headers.get('X-User-ID')
if user_id:
    tasks = TaskInfo.query.filter_by(user_id=int(user_id)).all()
else:
    tasks = TaskInfo.query.all()  # å‘åå…¼å®¹
```

2. **åˆ›å»ºä»»åŠ¡ï¼ˆè‡ªåŠ¨å…³è”ï¼‰**ï¼š
```python
# POST /api/tasks
user_id = data.get('user_id') or request.headers.get('X-User-ID') or 3
new_task = TaskInfo(
    # ...
    user_id=int(user_id)  # â† è‡ªåŠ¨å…³è”åˆ°å½“å‰ç”¨æˆ·
)
```

3. **æ›´æ–°ä»»åŠ¡ï¼ˆç¦æ­¢ä¿®æ”¹ user_idï¼‰**ï¼š
```python
# PUT /api/tasks/<task_name>
for key, value in data.items():
    if key not in ['task_name', 'user_id'] and hasattr(task, key):
        setattr(task, key, value)
```

### 4. æ–‡æ¡£åˆ›å»º âœ“

- âœ… `ç”¨æˆ·éš”ç¦»åŠŸèƒ½è¯´æ˜.md` - è¯¦ç»†åŠŸèƒ½è¯´æ˜
- âœ… `ç”¨æˆ·éš”ç¦»åŠŸèƒ½å®ç°æ€»ç»“.md` - æœ¬æ–‡æ¡£

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### åç«¯ä½¿ç”¨

1. **é‡å¯åç«¯æœåŠ¡**
   ```bash
   # åœæ­¢å½“å‰åç«¯ï¼ˆæŒ‰ Ctrl+Cï¼‰
   cd backend
   python app.py
   ```

2. **æµ‹è¯•ç”¨æˆ·ç™»å½•**
   ```bash
   curl -X POST http://localhost:5000/api/login \
     -H "Content-Type: application/json" \
     -d '{"username":"123","password":"123456"}'
   ```
   
   **è¿”å›**ï¼š
   ```json
   {
     "code": 200,
     "data": {
       "id": 3,           // â† ç”¨æˆ· ID
       "username": "123",
       "role": "æ™®é€šç”¨æˆ·"
     }
   }
   ```

3. **æµ‹è¯•ç”¨æˆ·éš”ç¦»**
   ```bash
   # è·å– user_id=3 çš„ä»»åŠ¡
   curl "http://localhost:5000/api/tasks?user_id=3"
   
   # åˆ›å»ºæ–°ä»»åŠ¡ï¼ˆå…³è”åˆ° user_id=3ï¼‰
   curl -X POST http://localhost:5000/api/tasks \
     -H "Content-Type: application/json" \
     -d '{"task_name":"æµ‹è¯•ä»»åŠ¡","project":"æµ‹è¯•","user_id":3}'
   ```

### å‰ç«¯ä½¿ç”¨

#### 1. ç™»å½•æ—¶ä¿å­˜ç”¨æˆ· ID
```javascript
// src/views/pages/login.vue
const login = async () => {
  const res = await loginUser({
    username: formData.username,
    password: formData.password
  });
  
  if (res.data.code === 200) {
    // ä¿å­˜ç”¨æˆ· ID
    const userId = res.data.data.id;
    localStorage.setItem('userId', userId);
    localStorage.setItem('username', res.data.data.username);
    
    ElMessage.success('ç™»å½•æˆåŠŸ');
    router.push('/dashboard');
  }
};
```

#### 2. è·å–æ•°æ®æ—¶æºå¸¦ user_id

**ä¿®æ”¹ `src/views/VoyageInfo/task-manage.vue`**ï¼š
```javascript
const getData = () => {
  const userId = localStorage.getItem('userId');
  
  // æºå¸¦ user_id å‚æ•°
  fetchTasksNew({ user_id: userId }).then(res => {
    tableData.value = res.data.data.list;
    pageTotal.value = res.data.data.pageTotal;
  });
};
```

#### 3. åˆ›å»ºæ•°æ®æ—¶æºå¸¦ user_id

**ä¿®æ”¹ `src/views/VoyageInfo/task-manage.vue`**ï¼š
```javascript
const saveEdit = () => {
  const userId = localStorage.getItem('userId');
  
  const data = {
    ...formData.value,
    user_id: userId  // â† æºå¸¦å½“å‰ç”¨æˆ· ID
  };
  
  if (isEdit.value) {
    updateTask(formData.value.task_name, data).then(/* ... */);
  } else {
    createTask(data).then(/* ... */);
  }
};
```

#### 4. è¡¨å•é€‰é¡¹ä¸­éšè— user_id

**ä¿®æ”¹ `src/views/VoyageInfo/task-manage.vue`**ï¼š
```javascript
const options = ref([
  // ... å…¶ä»–å­—æ®µ
  {
    label: 'åˆ›å»ºç”¨æˆ·ID',
    prop: 'user_id',
    type: 'number',
    disabled: true,   // ç¦æ­¢ç¼–è¾‘
    visible: false    // æˆ–è€…ç›´æ¥éšè—
  }
]);
```

## ğŸ“Š æ•°æ®éš”ç¦»æ•ˆæœ

### ç”¨æˆ·1ï¼ˆID=1ï¼‰
- ç™»å½•åè·å– `user_id=1`
- æŸ¥è¯¢ä»»åŠ¡ï¼š`GET /api/tasks?user_id=1` â†’ åªè¿”å› `user_id=1` çš„ä»»åŠ¡
- åˆ›å»ºä»»åŠ¡ï¼šè‡ªåŠ¨ `user_id=1`
- **çœ‹ä¸åˆ°** å…¶ä»–ç”¨æˆ·çš„ä»»åŠ¡

### ç”¨æˆ·3ï¼ˆID=3ï¼‰
- ç™»å½•åè·å– `user_id=3`
- æŸ¥è¯¢ä»»åŠ¡ï¼š`GET /api/tasks?user_id=3` â†’ è¿”å› 5 ä¸ªä»»åŠ¡ï¼ˆæ‰€æœ‰ç°æœ‰ä»»åŠ¡ï¼‰
- åˆ›å»ºä»»åŠ¡ï¼šè‡ªåŠ¨ `user_id=3`
- **å¯ä»¥çœ‹åˆ°** æ‰€æœ‰ç°æœ‰æ•°æ®ï¼ˆå› ä¸ºé»˜è®¤éƒ½æ˜¯ `user_id=3`ï¼‰

### æ–°ç”¨æˆ·ï¼ˆID=4ï¼‰
- ç™»å½•åè·å– `user_id=4`
- æŸ¥è¯¢ä»»åŠ¡ï¼š`GET /api/tasks?user_id=4` â†’ è¿”å›ç©ºåˆ—è¡¨
- åˆ›å»ºä»»åŠ¡ï¼šè‡ªåŠ¨ `user_id=4`
- **åªèƒ½çœ‹åˆ°** è‡ªå·±åˆ›å»ºçš„ä»»åŠ¡

## ğŸ” å®‰å…¨æ€§è¯´æ˜

### å½“å‰å®ç°ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
- âœ… ç”¨æˆ·IDé€šè¿‡è¯·æ±‚å‚æ•°æˆ–è¯·æ±‚å¤´ä¼ é€’
- âš ï¸ **ä¸å¤Ÿå®‰å…¨**ï¼šç”¨æˆ·å¯ä»¥ä¿®æ”¹è¯·æ±‚å‚æ•°å‡å†’å…¶ä»–ç”¨æˆ·

### ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼ˆTODOï¼‰

#### 1. ä½¿ç”¨ JWT è®¤è¯
```python
# ç™»å½•æ—¶ç”Ÿæˆ token
import jwt

@auth_bp.route('/login', methods=['POST'])
def login():
    # ... éªŒè¯ç”¨æˆ·
    token = jwt.encode(
        {'user_id': user.id, 'username': user.name},
        'secret_key',
        algorithm='HS256'
    )
    return jsonify({'code': 200, 'token': token})

# å…¶ä»–æ¥å£éªŒè¯ token
from functools import wraps

def token_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        token = request.headers.get('Authorization')
        if not token:
            return jsonify({'code': 401, 'message': 'æœªæˆæƒ'}), 401
        
        try:
            data = jwt.decode(token, 'secret_key', algorithms=['HS256'])
            current_user_id = data['user_id']
        except:
            return jsonify({'code': 401, 'message': 'Tokenæ— æ•ˆ'}), 401
        
        return f(current_user_id, *args, **kwargs)
    return decorated

@task_bp.route('/tasks', methods=['GET'])
@token_required
def get_tasks(current_user_id):
    tasks = TaskInfo.query.filter_by(user_id=current_user_id).all()
    # ...
```

#### 2. ä½¿ç”¨ Flask-Login
```python
from flask_login import LoginManager, login_user, current_user

login_manager = LoginManager()
login_manager.init_app(app)

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

@task_bp.route('/tasks', methods=['GET'])
@login_required
def get_tasks():
    tasks = TaskInfo.query.filter_by(user_id=current_user.id).all()
    # ...
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. åç«¯å¿…é¡»é‡å¯
ä¿®æ”¹ Models åï¼ŒFlask çš„è‡ªåŠ¨é‡è½½å¯èƒ½ä¸ç”Ÿæ•ˆï¼Œ**å¿…é¡»æ‰‹åŠ¨é‡å¯**ï¼š
```bash
# æŒ‰ Ctrl+C åœæ­¢å½“å‰åç«¯
cd backend
python app.py
```

### 2. å‰ç«¯éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

- âœ… `src/views/pages/login.vue` - ä¿å­˜ç”¨æˆ· ID
- âœ… `src/views/VoyageInfo/task-manage.vue` - è·å–/åˆ›å»ºä»»åŠ¡æ—¶æºå¸¦ user_id
- âœ… `src/views/preVoyageInspection/inspection-task-list.vue` - è·å–ä»»åŠ¡æ—¶æºå¸¦ user_id
- âœ… `src/api/task.ts` - ä¿®æ”¹ API è°ƒç”¨æ”¯æŒ user_id å‚æ•°

### 3. API è°ƒç”¨ç¤ºä¾‹

#### å‰ç«¯ API å°è£…
```javascript
// src/api/task.ts
export const fetchTasksNew = (params) => {
  return request({
    url: '/tasks',
    method: 'get',
    params  // { user_id: 3 }
  });
};

export const createTask = (data) => {
  return request({
    url: '/tasks',
    method: 'post',
    data  // { task_name: '...', user_id: 3 }
  });
};
```

### 4. å‘åå…¼å®¹
- å¦‚æœå‰ç«¯ä¸ä¼  `user_id`ï¼Œåç«¯è¿”å›æ‰€æœ‰æ•°æ®
- è¿™æ ·å¯ä»¥ä¿è¯å‰ç«¯æœªå®Œæˆé€‚é…æ—¶ï¼Œç³»ç»Ÿä»å¯ç”¨
- **å»ºè®®å‰ç«¯å°½å¿«å®Œæˆé€‚é…**

## ğŸ§ª æµ‹è¯•æ¸…å•

### åç«¯æµ‹è¯• âœ“

- [x] æ•°æ®åº“ç»“æ„æ›´æ–°æˆåŠŸ
- [x] tb_user è¡¨æœ‰ id ä¸»é”®
- [x] tb_task_info è¡¨æœ‰ user_id åˆ—
- [x] ç°æœ‰æ•°æ® user_id éƒ½æ˜¯ 3
- [x] Models æ›´æ–°æˆåŠŸ
- [x] Controllers æ›´æ–°æˆåŠŸ
- [ ] é‡å¯åç«¯æµ‹è¯• APIï¼ˆéœ€è¦æ‰‹åŠ¨é‡å¯ï¼‰

### å‰ç«¯æµ‹è¯•ï¼ˆå¾…å®Œæˆï¼‰

- [ ] ç™»å½•æ—¶èƒ½è·å–å¹¶ä¿å­˜ user_id
- [ ] è·å–ä»»åŠ¡æ—¶æºå¸¦ user_id å‚æ•°
- [ ] åˆ›å»ºä»»åŠ¡æ—¶æºå¸¦ user_id
- [ ] user_id å­—æ®µåœ¨è¡¨å•ä¸­ç¦ç”¨æˆ–éšè—
- [ ] ç”¨æˆ·Açœ‹ä¸åˆ°ç”¨æˆ·Bçš„æ•°æ®

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **`ç”¨æˆ·éš”ç¦»åŠŸèƒ½è¯´æ˜.md`** - è¯¦ç»†çš„åŠŸèƒ½è¯´æ˜å’Œ API æ–‡æ¡£
2. **`backend/update_database_structure.py`** - æ•°æ®åº“æ›´æ–°è„šæœ¬
3. **`backend/add_user_id_column.sql`** - SQL è„šæœ¬ï¼ˆå‚è€ƒï¼‰

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ

1. **é‡å¯åç«¯**
   ```bash
   cd backend
   python app.py
   ```

2. **å‰ç«¯é€‚é…**ï¼ˆæŒ‰é¡ºåºä¿®æ”¹ï¼‰
   - [ ] `login.vue` - ä¿å­˜ user_id
   - [ ] `task-manage.vue` - ä½¿ç”¨ user_id
   - [ ] `inspection-task-list.vue` - ä½¿ç”¨ user_id
   - [ ] `task.ts` - API æ”¯æŒ user_id

3. **æµ‹è¯•éªŒè¯**
   - [ ] ç”¨æˆ·ç™»å½•
   - [ ] åˆ›å»ºä»»åŠ¡
   - [ ] æŸ¥çœ‹ä»»åŠ¡ï¼ˆåªçœ‹åˆ°è‡ªå·±çš„ï¼‰
   - [ ] åˆ‡æ¢ç”¨æˆ·æµ‹è¯•éš”ç¦»

### åç»­ä¼˜åŒ–

- [ ] å®ç° JWT è®¤è¯
- [ ] æ·»åŠ æ•°æ®åº“å¤–é”®çº¦æŸ
- [ ] æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
- [ ] å®ç°ç®¡ç†å‘˜æƒé™ï¼ˆæŸ¥çœ‹æ‰€æœ‰æ•°æ®ï¼‰
- [ ] æ·»åŠ ç”¨æˆ·ç»„/éƒ¨é—¨éš”ç¦»

---

**å®Œæˆæ—¶é—´**ï¼š2025å¹´9æœˆ30æ—¥  
**å®ç°çŠ¶æ€**ï¼šâœ… åç«¯å®Œæˆï¼Œâ³ å‰ç«¯å¾…é€‚é…  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… æ•°æ®åº“éªŒè¯é€šè¿‡ï¼Œâ³ æ¥å£æµ‹è¯•å¾…é‡å¯åç«¯
