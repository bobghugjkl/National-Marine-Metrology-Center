# 数据库自动迁移说明

## 概述

为了确保在不同环境下数据库字段的完整性，系统在启动时会自动检查并添加用户表（`tb_user`）的缺失字段。

## 自动迁移的字段

系统会自动检查并添加以下字段：

| 字段名 | 类型 | 说明 | 添加时间 |
|--------|------|------|----------|
| `email` | VARCHAR(100) | 用户邮箱 | 2024-10-03 |
| `phone` | VARCHAR(20) | 用户电话 | 2024-10-03 |
| `signature` | TEXT | 手写签名数据 | 2024-10-03 |

## 工作原理

1. **启动时检查**：每次启动后端服务时，系统会自动执行字段检查
2. **智能检测**：通过查询 `INFORMATION_SCHEMA.COLUMNS` 表来判断字段是否存在
3. **安全添加**：只添加缺失的字段，已存在的字段会被跳过
4. **错误处理**：如果某个字段添加失败，不会影响其他字段的添加

## 迁移脚本位置

- **脚本文件**：`backend/auto_migrate_user_fields.py`
- **集成位置**：`backend/app.py` 中的 `create_app()` 函数
- **执行时机**：数据库初始化之后，CORS初始化之前

## 使用方法

### 自动执行（推荐）

系统启动时会自动执行，无需手动操作：

```bash
cd backend
python app.py
```

### 手动执行

如果需要手动执行迁移：

```bash
cd backend
python auto_migrate_user_fields.py
```

## 输出示例

### 首次运行（需要添加字段）
```
开始检查用户表字段...
检测到缺失字段 email(邮箱)，正在添加...
✓ 字段 email 添加成功
检测到缺失字段 phone(电话)，正在添加...
✓ 字段 phone 添加成功
检测到缺失字段 signature(手写签名)，正在添加...
✓ 字段 signature 添加成功
成功添加字段: email, phone, signature
用户表字段检查完成
用户表字段迁移完成
```

### 后续运行（字段已存在）
```
开始检查用户表字段...
✓ 字段 email 已存在，跳过
✓ 字段 phone 已存在，跳过
✓ 字段 signature 已存在，跳过
已存在字段: email, phone, signature
用户表字段检查完成
用户表字段迁移完成
```

## 注意事项

1. **数据库权限**：确保数据库用户有 `ALTER TABLE` 权限
2. **备份建议**：在生产环境执行前建议备份数据库
3. **字段冲突**：如果字段已存在但类型不同，会跳过添加
4. **错误处理**：单个字段添加失败不会影响整个迁移过程

## 扩展说明

如果需要添加新的字段，可以修改 `auto_migrate_user_fields.py` 中的 `required_fields` 列表：

```python
required_fields = [
    {'name': 'email', 'type': 'VARCHAR(100)', 'comment': '邮箱'},
    {'name': 'phone', 'type': 'VARCHAR(20)', 'comment': '电话'},
    {'name': 'signature', 'type': 'TEXT', 'comment': '手写签名'},
    # 添加新字段
    {'name': 'new_field', 'type': 'VARCHAR(50)', 'comment': '新字段说明'}
]
```

## 故障排除

### 常见问题

1. **权限不足**：确保数据库用户有足够的权限
2. **字段已存在**：系统会自动跳过已存在的字段
3. **类型冲突**：如果字段已存在但类型不同，需要手动处理

### 日志查看

迁移过程的详细信息会输出到控制台，包括：
- 字段检查结果
- 添加操作状态
- 错误信息（如果有）

## 版本历史

- **v1.0** (2024-10-03): 初始版本，支持 email、phone、signature 字段的自动添加
