# 数据库检查启动说明

## 概述

为了满足不同环境下的数据库字段检查需求，系统提供了多种启动方式，可以根据需要选择不同的检查级别。

## 启动方式

### 1. 标准启动（推荐）

只检查用户表字段，适合日常使用：

```bash
cd backend
python app.py
```

或者：

```bash
cd backend
python start_with_full_check.py
```

### 2. 全面检查启动

检查所有表的字段，适合新环境部署：

```bash
cd backend
python start_with_full_check.py --full-check
```

### 3. 手动检查

单独执行数据库检查：

```bash
# 只检查用户表
cd backend
python auto_migrate_user_fields.py

# 全面检查所有表
cd backend
python check_all_tables_fields.py
```

## 检查级别对比

| 启动方式 | 检查范围 | 适用场景 | 执行时间 |
|----------|----------|----------|----------|
| 标准启动 | 用户表字段 | 日常开发/生产 | 快速 |
| 全面检查 | 所有主要表 | 新环境部署 | 较慢 |
| 手动检查 | 可自定义 | 故障排除 | 按需 |

## 推荐使用场景

### 日常开发
```bash
cd backend
python app.py
```
- 只检查用户表字段
- 启动速度快
- 满足基本需求

### 新环境部署
```bash
cd backend
python start_with_full_check.py --full-check
```
- 检查所有表字段
- 确保数据库完整性
- 适合首次部署

### 故障排除
```bash
cd backend
python check_all_tables_fields.py
```
- 手动执行检查
- 查看详细报告
- 针对性解决问题

## 配置说明

### 修改检查范围

在 `backend/app.py` 中修改检查配置：

```python
# 只检查用户表（默认）
with app.app_context():
    from auto_migrate_user_fields import run_migration
    run_migration()

# 启用全面检查（取消注释）
# with app.app_context():
#     from check_all_tables_fields import run_comprehensive_check
#     run_comprehensive_check()
```

### 自定义检查表

在 `backend/check_all_tables_fields.py` 中修改 `get_expected_fields()` 函数，添加或移除需要检查的表。

## 输出示例

### 标准启动输出
```
开始检查用户表字段...
字段 email 已存在，跳过
字段 phone 已存在，跳过
字段 signature 已存在，跳过
已存在字段: email, phone, signature
用户表字段检查完成
用户表字段迁移完成
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
 * Running on http://[::1]:5000
```

### 全面检查输出
```
============================================================
启动应用并执行全面数据库字段检查...
============================================================

开始执行全面数据库字段检查...
开始全面数据库字段检查...
开始检查所有数据库表字段...
============================================================

检查表: tb_user
----------------------------------------
所有必需字段都存在
没有额外字段

检查表: tb_task_info
----------------------------------------
所有必需字段都存在
没有额外字段

数据库字段检查完成!
统计信息:
   - 缺失字段: 0
   - 成功添加: 0
   - 额外字段: 0
数据库字段检查完成

数据库字段检查完成，应用启动成功!

启动Flask应用...
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
 * Running on http://[::1]:5000
```

## 注意事项

1. **首次部署**：建议使用全面检查启动
2. **日常使用**：使用标准启动即可
3. **性能考虑**：全面检查会检查所有表，首次运行较慢
4. **错误处理**：检查失败不会阻止应用启动
5. **权限要求**：确保数据库用户有 `ALTER TABLE` 权限

## 故障排除

### 检查失败
- 检查数据库连接
- 确认用户权限
- 查看错误日志

### 启动失败
- 检查Python环境
- 确认依赖包安装
- 检查端口占用

### 字段添加失败
- 手动执行SQL添加
- 检查字段类型冲突
- 确认表结构

## 最佳实践

1. **开发环境**：使用标准启动
2. **测试环境**：使用全面检查启动
3. **生产环境**：先手动检查，再标准启动
4. **新部署**：使用全面检查启动
5. **故障恢复**：使用手动检查定位问题
