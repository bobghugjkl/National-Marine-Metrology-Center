# 统一后端启动说明

## ✅ 已完成整合

现在所有后端功能已经整合到一个 `app.py` 文件中，**只需要启动一个服务即可**！

---

## 🚀 启动方式

### 后端启动（只需一条命令）

```bash
cd backend
python app.py
```

就这么简单！所有功能都在端口 **5000** 上运行。

### 前端启动

```bash
npm run dev
```

---

## 📋 服务说明

启动后，`app.py` 会提供以下所有功能：

### 1. 用户管理 API
- `GET /api/users` - 获取用户列表（支持搜索）
- `POST /api/users` - 创建用户
- `PUT /api/users/<name>` - 更新用户
- `DELETE /api/users/<name>` - 删除用户

### 2. 登录注册 API
- `POST /api/login` - 用户登录
- `POST /api/register` - 用户注册

### 3. 任务管理 API（原端口5001，现已整合）
- `GET /api/tasks` - 获取任务列表
- `POST /api/tasks` - 创建任务（自动创建检查记录）
- `PUT /api/tasks/<task_name>` - 更新任务
- `DELETE /api/tasks/<task_name>` - 删除任务（自动删除检查记录）

### 4. 检查记录 API（原端口5002，现已整合）
- `GET /api/inspections` - 获取所有检查记录
- `GET /api/inspections/<task_name>` - 获取指定任务的检查记录
- `PUT /api/inspections/<task_name>` - 更新检查记录
- `POST /api/inspections` - 创建检查记录（自动）
- `DELETE /api/inspections/<task_name>` - 删除检查记录（自动）

### 5. 健康检查 API
- `GET /api/health` - 检查服务状态

---

## 🔧 修改内容

### 后端修改
1. ✅ 创建了统一的 `app.py`（所有模型和接口都在一个文件中）
2. ✅ 备份了原来的 `app.py` 为 `app_old_backup.py`
3. ✅ 解决了 SQLAlchemy 多实例冲突问题
4. ✅ 在 `app.py` 中直接定义所有模型（User, TaskInfo, PreVoyageInspection）
5. ✅ 所有API路由都在 `app.py` 中定义，无需蓝图

### 前端修改
1. ✅ 修改了 `src/api/task.ts`：端口从 5001 → 5000
2. ✅ 修改了 `src/api/inspection.ts`：端口从 5002 → 5000
3. ✅ 所有API现在都指向统一端口 5000

---

## 📂 文件结构

```
backend/
├── app.py                    # 统一后端服务（新）✅
├── app_old_backup.py         # 原app.py备份
├── app_task.py              # 任务管理后端（已废弃，不再需要）
├── app_inspection.py        # 检查记录后端（已废弃，不再需要）
├── app_unified.py           # 统一版本源文件
├── models_task.py           # 任务模型
├── models_inspection.py     # 检查记录模型
├── routes_task.py           # 任务路由（蓝图）
├── routes_inspection.py     # 检查记录路由（蓝图）
└── ...
```

---

## 🎯 优势

### 之前（3个后端）
```bash
# 终端1
python app.py            # 端口5000（用户管理）

# 终端2
python app_task.py       # 端口5001（任务管理）

# 终端3
python app_inspection.py # 端口5002（检查记录）
```
❌ 需要开3个终端  
❌ 管理复杂  
❌ 端口占用多  

### 现在（1个后端）
```bash
# 只需一个终端
python app.py            # 端口5000（所有功能）
```
✅ 只需1个终端  
✅ 管理简单  
✅ 端口占用少  

---

## 🔗 数据联动（保持不变）

### 创建任务时
1. 创建任务记录
2. **自动创建**对应的空检查记录

### 删除任务时
1. 删除任务记录
2. **自动删除**对应的检查记录

---

## 🆘 常见问题

### Q1: 启动后端报错？
**A**: 检查是否有其他服务占用5000端口
```bash
# Windows 查看端口占用
netstat -ano | findstr :5000

# 如果有占用，关闭对应进程或换个端口
```

### Q2: 前端无法获取数据？
**A**: 
1. 检查后端是否正常启动（应该显示统一服务信息）
2. 检查浏览器控制台是否有CORS错误
3. 访问 `http://localhost:5000/api/health` 检查服务状态

### Q3: 数据库连接失败？
**A**: 
1. 检查MySQL是否运行
2. 检查数据库名称、用户名、密码是否正确
3. 检查 `app.py` 中的 `SQLALCHEMY_DATABASE_URI`

### Q4: 旧的后端文件需要删除吗？
**A**: 
- `app_task.py` 和 `app_inspection.py` 已经不需要了，可以删除
- `app_old_backup.py` 是备份，可以保留或删除
- `app_unified.py` 是源文件，已经不需要了（内容已整合到app.py）
- `models_task.py` 和 `models_inspection.py` 仍然存在，但不再被使用（模型已在app.py中重新定义）

### Q5: 为什么会有 "SQLAlchemy instance already registered" 错误？
**A**: 
- 原因：`models_task.py` 和 `models_inspection.py` 各自创建了 `db` 实例
- 解决：在 `app.py` 中创建唯一的 `db` 实例，并直接定义所有模型
- 现在所有模型都使用同一个 `db` 实例，不会再有冲突

---

## ✨ 总结

现在只需要：
1. **启动1个后端**：`python app.py`（端口5000）
2. **启动前端**：`npm run dev`

所有功能都可以正常使用了！🎉

---

## 📝 技术细节

### 使用的技术
- Flask - Web框架
- SQLAlchemy（ORM）- 数据库操作
- Flask-CORS - 跨域支持
- 单一数据库实例 - 统一管理所有模型

### 核心设计
```python
# 创建唯一的 db 实例
db = SQLAlchemy(app)

# 所有模型都使用这个 db 实例
class User(db.Model):
    ...

class TaskInfo(db.Model):
    ...

class PreVoyageInspection(db.Model):
    ...
```

### 路由映射
| 原路由 | 新路由 | 说明 |
|--------|--------|------|
| `http://localhost:5001/api/tasks` | `http://localhost:5000/api/tasks` | 任务管理 |
| `http://localhost:5002/api/inspections` | `http://localhost:5000/api/inspections` | 检查记录 |
| `http://localhost:5000/api/users` | `http://localhost:5000/api/users` | 用户管理（不变） |

---

**现在可以重启后端和前端测试了！** 🚀
