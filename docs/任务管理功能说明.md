# 任务管理功能实现说明

## ✅ 已完成功能

### 1. 任务管理模块
- ✅ 独立的后端服务（端口 5001）
- ✅ 完整的增删改查功能
- ✅ 搜索功能（按任务名称）
- ✅ 使用 `tb_task_info` 数据库表
- ✅ 通用的 CRUD 实现（可复用）

---

## 📁 文件结构

### 后端文件（Backend）
```
backend/
├── app_task.py          # 任务管理主程序（端口 5001）
├── models_task.py       # 任务数据模型
├── routes_task.py       # 任务路由（增删改查）
└── init_task_data.py    # 初始化任务数据脚本
```

### 前端文件（Frontend）
```
src/
├── views/VoyageInfo/
│   └── task-manage.vue  # 任务管理页面
└── api/
    └── task.ts          # 任务 API 接口
```

---

## 🗄️ 数据库表结构

### tb_task_info（任务信息表）

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| task_name | VARCHAR(100) | 航次任务名称（主键） | 东海海洋调查 |
| project | VARCHAR(100) | 专项名称 | 海洋资源调查专项 |
| task_code | VARCHAR(100) | 航次任务编号 | HY2025001 |
| undertake | VARCHAR(100) | 航次承担单位 | 国家海洋标准计量中心 |
| participant | VARCHAR(200) | 航次参与单位 | - |
| ship | VARCHAR(45) | 调查船 | 向阳红01 |
| leader | VARCHAR(45) | 任务负责人 | 张主任 |
| chief_scientist | VARCHAR(45) | 首席科学家 | - |
| superintendent | VARCHAR(100) | 随船监督员 | - |
| superintended | VARCHAR(45) | 随船监督 | - |
| executiontime | TEXT | 执行时间 | 2025-01-15 至 2025-02-20 |
| subject | VARCHAR(45) | 任务学科 | 海洋地质 |

### 初始数据
- 东海海洋调查
- 南海深海探测
- 渤海环境监测
- （其他已有数据...）

---

## 🔧 后端实现

### 1. 数据模型（models_task.py）

```python
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()

class TaskInfo(db.Model):
    __tablename__ = 'tb_task_info'
    
    task_name = db.Column(db.String(100), primary_key=True)
    project = db.Column(db.String(100))
    task_code = db.Column(db.String(100))
    # ... 其他字段
    
    def to_dict(self):
        return {
            'task_name': self.task_name,
            'project': self.project,
            # ...
        }
```

### 2. 路由实现（routes_task.py）

#### 获取任务列表（支持搜索）
```python
@task_bp.route('', methods=['GET'])
def get_tasks():
    task_name = request.args.get('task_name', '')
    
    if task_name:
        tasks = TaskInfo.query.filter(
            TaskInfo.task_name.like(f'%{task_name}%')
        ).all()
    else:
        tasks = TaskInfo.query.all()
    
    return jsonify({
        'code': 200,
        'data': {
            'list': [t.to_dict() for t in tasks],
            'pageTotal': len(tasks)
        }
    })
```

#### 创建任务
```python
@task_bp.route('', methods=['POST'])
def create_task():
    data = request.json
    
    # 检查任务名称是否已存在
    if TaskInfo.query.filter_by(task_name=data.get('task_name')).first():
        return jsonify({'code': 400, 'message': '任务名称已存在'}), 400
    
    # 创建新任务
    new_task = TaskInfo(**data)
    db.session.add(new_task)
    db.session.commit()
    
    return jsonify({'code': 200, 'message': '创建成功'})
```

#### 更新任务
```python
@task_bp.route('/<task_name>', methods=['PUT'])
def update_task(task_name):
    task = TaskInfo.query.filter_by(task_name=task_name).first()
    
    if not task:
        return jsonify({'code': 404, 'message': '任务不存在'}), 404
    
    # 更新字段
    for key, value in request.json.items():
        if hasattr(task, key):
            setattr(task, key, value)
    
    db.session.commit()
    return jsonify({'code': 200, 'message': '更新成功'})
```

#### 删除任务
```python
@task_bp.route('/<task_name>', methods=['DELETE'])
def delete_task(task_name):
    task = TaskInfo.query.filter_by(task_name=task_name).first()
    
    if not task:
        return jsonify({'code': 404, 'message': '任务不存在'}), 404
    
    db.session.delete(task)
    db.session.commit()
    
    return jsonify({'code': 200, 'message': '删除成功'})
```

### 3. 主程序（app_task.py）

```python
from flask import Flask
from flask_cors import CORS
from models_task import db
from routes_task import task_bp

app = Flask(__name__)

# 数据库配置
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://root:WASDijkl15963@localhost:3306/marine_survey_db'

# 初始化
db.init_app(app)
CORS(app)

# 注册路由
app.register_blueprint(task_bp)

if __name__ == '__main__':
    app.run(debug=True, port=5001)  # 使用 5001 端口
```

---

## 🎨 前端实现

### 1. API 接口（src/api/task.ts）

```typescript
import request from '../utils/request';

// 使用独立的后端端口 5001
const taskRequest = (config: any) => {
    return request({
        ...config,
        baseURL: 'http://localhost:5001/api'
    });
};

// 获取任务列表
export const fetchTasksNew = (params?: any) => {
    return taskRequest({
        url: '/tasks',
        method: 'get',
        params
    });
};

// 创建任务
export const createTaskNew = (data: any) => {
    return taskRequest({
        url: '/tasks',
        method: 'post',
        data
    });
};

// 更新任务
export const updateTaskNew = (task_name: string, data: any) => {
    return taskRequest({
        url: `/tasks/${encodeURIComponent(task_name)}`,
        method: 'put',
        data
    });
};

// 删除任务
export const deleteTaskNew = (task_name: string) => {
    return taskRequest({
        url: `/tasks/${encodeURIComponent(task_name)}`,
        method: 'delete'
    });
};
```

### 2. 任务管理页面（src/views/VoyageInfo/task-manage.vue）

#### 表格列定义
```typescript
const columns = ref([
    { type: 'index', label: '序号', width: 55 },
    { prop: 'task_name', label: '航次任务名称' },
    { prop: 'project', label: '专项名称' },
    { prop: 'task_code', label: '航次任务编号' },
    { prop: 'undertake', label: '航次承担单位' },
    { prop: 'ship', label: '调查船' },
    { prop: 'leader', label: '任务负责人' },
    { prop: 'operator', label: '操作', width: 250 },
])
```

#### 表单配置（动态禁用主键）
```typescript
const options = computed(() => ({
    labelWidth: '120px',
    span: 12,
    list: [
        { 
            type: 'input', 
            label: '航次任务名称', 
            prop: 'task_name', 
            required: true, 
            disabled: isEdit.value  // 编辑时禁用
        },
        { type: 'input', label: '专项名称', prop: 'project' },
        // ... 其他字段
    ]
}))
```

#### CRUD 操作
```typescript
// 获取数据
const getData = async () => {
    const params = query.task_name ? { task_name: query.task_name } : {};
    const res = await fetchTasksNew(params);
    tableData.value = res.data.data.list;
};

// 新增/更新
const updateData = async (formData: any) => {
    if (isEdit.value) {
        await updateTaskNew(formData.task_name, formData);
    } else {
        await createTaskNew(formData);
    }
    getData();
};

// 删除
const handleDelete = async (row: Task) => {
    await ElMessageBox.confirm('确定要删除该任务吗？');
    await deleteTaskNew(row.task_name);
    getData();
};
```

---

## 🚀 使用方法

### 1. 启动后端

#### 用户管理后端（端口 5000）
```bash
cd e:\OtherProoject\vue-manage-system\backend
python app.py
```

#### 任务管理后端（端口 5001）
```bash
cd e:\OtherProoject\vue-manage-system\backend
python app_task.py
```

### 2. 启动前端
```bash
cd e:\OtherProoject\vue-manage-system
npm run dev
```

### 3. 访问页面
- 前端：`http://localhost:5173`
- 任务管理页面：导航到"任务信息 → 任务管理"

---

## 🧪 测试指南

### 测试 1：查看任务列表
1. 访问任务管理页面
2. **预期结果**：显示所有任务（至少 5 个）

### 测试 2：搜索任务
1. 在搜索框输入：`东海`
2. 点击"搜索"
3. **预期结果**：只显示"东海海洋调查"

### 测试 3：新增任务
1. 点击"新增"按钮
2. 填写：
   - 航次任务名称：`黄海生态调查`
   - 专项名称：`海洋生态保护专项`
   - 航次任务编号：`HY2025004`
   - 调查船：`海洋六号`
   - 任务负责人：`赵博士`
3. 点击"确定"
4. **预期结果**：任务创建成功，列表刷新

### 测试 4：编辑任务
1. 点击任务的"编辑"按钮
2. 修改"专项名称"
3. 点击"确定"
4. **预期结果**：
   - ✅ 任务名称不可修改（灰色禁用）
   - ✅ 其他字段可以修改
   - ✅ 更新成功

### 测试 5：删除任务
1. 点击任务的"删除"按钮
2. 确认删除
3. **预期结果**：任务删除成功

---

## 🔑 核心特性

### 1. 通用 CRUD 实现
所有 CRUD 操作都是通用的，可以轻松复用到其他模块：

```python
# routes_task.py - 通用模式
@bp.route('', methods=['GET'])    # 查询
@bp.route('', methods=['POST'])   # 创建
@bp.route('/<id>', methods=['PUT'])    # 更新
@bp.route('/<id>', methods=['DELETE']) # 删除
```

### 2. 主键保护
- 新增时：必填
- 编辑时：禁用（防止修改主键导致数据混乱）

### 3. URL 编码
```typescript
encodeURIComponent(task_name)  // 支持中文任务名
```

### 4. 独立后端服务
- 用户管理：`http://localhost:5000/api`
- 任务管理：`http://localhost:5001/api`
- 便于模块化管理和部署

---

## 📊 API 接口文档

### 基础 URL
```
http://localhost:5001/api
```

### 1. 获取任务列表
```
GET /tasks?task_name=东海
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "task_name": "东海海洋调查",
        "project": "海洋资源调查专项",
        "task_code": "HY2025001",
        ...
      }
    ],
    "pageTotal": 1
  }
}
```

### 2. 创建任务
```
POST /tasks
Content-Type: application/json

{
  "task_name": "黄海生态调查",
  "project": "海洋生态保护专项",
  ...
}
```

### 3. 更新任务
```
PUT /tasks/东海海洋调查
Content-Type: application/json

{
  "project": "新的专项名称"
}
```

### 4. 删除任务
```
DELETE /tasks/东海海洋调查
```

---

## 🔄 复用到其他模块

这套 CRUD 模式可以轻松复用到其他模块（专家人员、设备管理等）：

### 步骤：
1. **复制文件并重命名**
   - `models_task.py` → `models_expert.py`
   - `routes_task.py` → `routes_expert.py`
   - `app_task.py` → `app_expert.py`

2. **修改模型定义**
   ```python
   class Expert(db.Model):
       __tablename__ = 'tb_expert'
       # 修改字段
   ```

3. **修改前端**
   - 复制 `task-manage.vue` → `expert-manage.vue`
   - 修改表格列和表单字段

4. **修改端口**
   ```python
   app.run(port=5002)  # 新模块用新端口
   ```

---

## ✅ 总结

### 已实现功能
1. ✅ 任务管理完整的 CRUD
2. ✅ 搜索功能（支持模糊查询）
3. ✅ 主键保护（编辑时禁用）
4. ✅ 独立后端服务
5. ✅ 通用的实现模式
6. ✅ 中文支持
7. ✅ 错误处理

### 技术栈
- **后端**：Flask + SQLAlchemy + PyMySQL
- **前端**：Vue 3 + Element Plus + TypeScript
- **数据库**：MySQL（tb_task_info 表）

### 当前运行的服务
- 用户管理后端：http://localhost:5000
- 任务管理后端：http://localhost:5001
- 前端：http://localhost:5173

**现在刷新浏览器，访问任务管理页面试试吧！** 🎉
