# ç”¨æˆ·éš”ç¦»åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°ç”¨æˆ·éš”ç¦»åŠŸèƒ½ï¼Œè®©æ¯ä¸ªç”¨æˆ·åªèƒ½çœ‹åˆ°å’Œç®¡ç†è‡ªå·±åˆ›å»ºçš„æ•°æ®ï¼ˆä»»åŠ¡ã€æ£€æŸ¥è®°å½•ç­‰ï¼‰ã€‚

## ğŸ”‘ æ ¸å¿ƒæ”¹åŠ¨

### 1. æ•°æ®åº“è¡¨ç»“æ„å˜æ›´

#### `tb_user` è¡¨
- âœ… æ·»åŠ è‡ªå¢ä¸»é”® `id`ï¼ˆåŸä¸»é”® `name` æ”¹ä¸ºå”¯ä¸€ç´¢å¼•ï¼‰
- **å­—æ®µ**ï¼š
  - `id` INT AUTO_INCREMENT PRIMARY KEY
  - `name` VARCHAR(45) UNIQUE NOT NULL

#### `tb_task_info` è¡¨
- âœ… æ·»åŠ  `user_id` åˆ—
- **å­—æ®µ**ï¼š`user_id` INT NOT NULL DEFAULT 3 COMMENT 'åˆ›å»ºä»»åŠ¡çš„ç”¨æˆ·ID'
- **å…³è”**ï¼šå…³è”åˆ° `tb_user.id`

#### `tb_task_hqzljdjcjlb` è¡¨
- âœ… æ·»åŠ  `user_id` åˆ—
- **å­—æ®µ**ï¼š`user_id` INT NOT NULL DEFAULT 3 COMMENT 'åˆ›å»ºæ£€æŸ¥è®°å½•çš„ç”¨æˆ·ID'

#### `tb_base_master` è¡¨
- âœ… æ·»åŠ  `user_id` åˆ—
- **å­—æ®µ**ï¼š`user_id` INT NOT NULL DEFAULT 3 COMMENT 'åˆ›å»ºäººå‘˜ä¿¡æ¯çš„ç”¨æˆ·ID'

### 2. Models æ›´æ–°

#### `User` æ¨¡å‹
```python
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)  # æ–°ä¸»é”®
    name = db.Column(db.String(45), unique=True, nullable=False)     # æ”¹ä¸ºå”¯ä¸€ç´¢å¼•
    # ... å…¶ä»–å­—æ®µ
```

#### `TaskInfo` æ¨¡å‹
```python
class TaskInfo(db.Model):
    # ... å…¶ä»–å­—æ®µ
    user_id = db.Column(db.Integer, nullable=False, comment='åˆ›å»ºä»»åŠ¡çš„ç”¨æˆ·ID')
```

#### `PreVoyageInspection` æ¨¡å‹
```python
class PreVoyageInspection(db.Model):
    # ... å…¶ä»–å­—æ®µ
    user_id = db.Column(db.Integer, nullable=False, comment='åˆ›å»ºæ£€æŸ¥è®°å½•çš„ç”¨æˆ·ID')
```

### 3. Controllers æ›´æ–°

#### ç”¨æˆ·æ§åˆ¶å™¨ï¼ˆ`user_controller.py`ï¼‰
- âœ… æ›´æ–°æŸ¥è¯¢æ–¹å¼ï¼ˆä¸»é”®ä» `name` æ”¹ä¸º `id`ï¼‰
- âœ… ç¦æ­¢ä¿®æ”¹ `id` å’Œ `name`

#### è®¤è¯æ§åˆ¶å™¨ï¼ˆ`auth_controller.py`ï¼‰
- âœ… ç™»å½•æˆåŠŸè¿”å›ç”¨æˆ· `id`
```python
return jsonify({
    'code': 200,
    'data': {
        'id': user.id,          # â† æ–°å¢
        'username': user.name,
        'role': user.role,
        # ...
    }
})
```

#### ä»»åŠ¡æ§åˆ¶å™¨ï¼ˆ`task_controller.py`ï¼‰
- âœ… **è·å–ä»»åŠ¡**ï¼šæ ¹æ® `user_id` è¿‡æ»¤ï¼ˆç”¨æˆ·éš”ç¦»ï¼‰
```python
@task_bp.route('/tasks', methods=['GET'])
def get_tasks():
    user_id = request.args.get('user_id') or request.headers.get('X-User-ID')
    if user_id:
        tasks = TaskInfo.query.filter_by(user_id=int(user_id)).all()
    else:
        tasks = TaskInfo.query.all()  # å‘åå…¼å®¹
```

- âœ… **åˆ›å»ºä»»åŠ¡**ï¼šè‡ªåŠ¨å…³è”å½“å‰ç”¨æˆ·
```python
@task_bp.route('/tasks', methods=['POST'])
def create_task():
    user_id = data.get('user_id') or request.headers.get('X-User-ID') or 3
    new_task = TaskInfo(
        # ... å…¶ä»–å­—æ®µ
        user_id=int(user_id)  # â† è‡ªåŠ¨å…³è”
    )
```

- âœ… **æ›´æ–°ä»»åŠ¡**ï¼šç¦æ­¢ä¿®æ”¹ `user_id`
```python
for key, value in data.items():
    if key not in ['task_name', 'user_id'] and hasattr(task, key):
        setattr(task, key, value)
```

## ğŸ” ç”¨æˆ·éš”ç¦»é€»è¾‘

### å·¥ä½œæµç¨‹

1. **ç”¨æˆ·ç™»å½•**
   - ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
   - åç«¯éªŒè¯æˆåŠŸï¼Œè¿”å› `user.id`
   - å‰ç«¯ä¿å­˜ `user.id` åˆ° localStorage æˆ– Vuex

2. **è·å–æ•°æ®ï¼ˆéš”ç¦»ï¼‰**
   - å‰ç«¯å‘é€è¯·æ±‚æ—¶æºå¸¦ `user_id` å‚æ•°æˆ–è¯·æ±‚å¤´
   - åç«¯æ ¹æ® `user_id` è¿‡æ»¤æ•°æ®
   - åªè¿”å›è¯¥ç”¨æˆ·åˆ›å»ºçš„æ•°æ®

3. **åˆ›å»ºæ•°æ®ï¼ˆè‡ªåŠ¨å…³è”ï¼‰**
   - å‰ç«¯åˆ›å»ºæ•°æ®æ—¶å‘é€ `user_id`
   - åç«¯è‡ªåŠ¨å°† `user_id` å…³è”åˆ°æ–°æ•°æ®
   - ç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„æ•°æ®

4. **æ›´æ–°æ•°æ®ï¼ˆç¦æ­¢è½¬ç§»ï¼‰**
   - `user_id` å­—æ®µä¸å¯ç¼–è¾‘
   - ç”¨æˆ·1åˆ›å»ºçš„ä»»åŠ¡ä¸èƒ½æ”¹æˆç”¨æˆ·2åˆ›å»ºçš„

### æ•°æ®éš”ç¦»ç¤ºä¾‹

#### ç”¨æˆ·1ï¼ˆid=1ï¼‰åˆ›å»ºä»»åŠ¡
```json
{
  "task_name": "ä»»åŠ¡A",
  "project": "é¡¹ç›®A",
  "user_id": 1  // è‡ªåŠ¨å…³è”åˆ°ç”¨æˆ·1
}
```

#### ç”¨æˆ·1æŸ¥è¯¢ä»»åŠ¡
```bash
GET /api/tasks?user_id=1
# åªè¿”å› user_id=1 çš„ä»»åŠ¡
```

#### ç”¨æˆ·2ï¼ˆid=2ï¼‰æŸ¥è¯¢ä»»åŠ¡
```bash
GET /api/tasks?user_id=2
# åªè¿”å› user_id=2 çš„ä»»åŠ¡ï¼ˆçœ‹ä¸åˆ°ç”¨æˆ·1çš„ä»»åŠ¡ï¼‰
```

## ğŸ“Š ç°æœ‰æ•°æ®å¤„ç†

### åˆå§‹æ•°æ®è®¾ç½®
- âœ… æ‰€æœ‰ç°æœ‰ä»»åŠ¡ï¼š`user_id = 3`ï¼ˆIDä¸º3çš„ç”¨æˆ·ï¼‰
- âœ… æ‰€æœ‰ç°æœ‰æ£€æŸ¥è®°å½•ï¼š`user_id = 3`
- âœ… æ‰€æœ‰ç°æœ‰äººå‘˜ä¿¡æ¯ï¼š`user_id = 3`

### ç”¨æˆ·åˆ—è¡¨ç¤ºä¾‹
| ID | Name | Login | Role |
|----|------|-------|------|
| 1 | 111 | test | 111 |
| 2 | 12 | 12 | 12 |
| 3 | 123 | 123 | æ™®é€šç”¨æˆ· |
| 4 | admin | admin | super_admin |
| 5 | newuser | newuser | æ™®é€šç”¨æˆ· |

**æ³¨æ„**ï¼šID=3 çš„ç”¨æˆ·ï¼ˆ123ï¼‰æ‹¥æœ‰æ‰€æœ‰ç°æœ‰æ•°æ®ã€‚

## ğŸ”¨ å‰ç«¯éœ€è¦çš„ä¿®æ”¹

### 1. ç™»å½•åä¿å­˜ç”¨æˆ·ID
```javascript
// login.vue
const login = async () => {
  const res = await loginUser(formData);
  if (res.data.code === 200) {
    const userId = res.data.data.id;  // â† è·å–ç”¨æˆ·ID
    localStorage.setItem('userId', userId);
    localStorage.setItem('username', res.data.data.username);
    router.push('/dashboard');
  }
};
```

### 2. è·å–ä»»åŠ¡æ—¶æºå¸¦ user_id
```javascript
// task-manage.vue
const getData = () => {
  const userId = localStorage.getItem('userId');
  fetchTasks({ user_id: userId }).then(res => {  // â† æºå¸¦ user_id
    tableData.value = res.data.data.list;
  });
};
```

### 3. åˆ›å»ºä»»åŠ¡æ—¶æºå¸¦ user_id
```javascript
// task-manage.vue
const saveEdit = () => {
  const userId = localStorage.getItem('userId');
  const data = {
    ...formData.value,
    user_id: userId  // â† æºå¸¦ user_id
  };
  createTask(data).then(/* ... */);
};
```

### 4. è¡¨å•é€‰é¡¹ä¸­ç¦ç”¨ user_id
```javascript
// task-manage.vue
const options = computed(() => {
  return [
    // ... å…¶ä»–å­—æ®µ
    {
      label: 'åˆ›å»ºç”¨æˆ·ID',
      prop: 'user_id',
      type: 'number',
      disabled: true,  // â† ç¦æ­¢ç¼–è¾‘
      visible: false   // â† æˆ–è€…ç›´æ¥éšè—
    }
  ];
});
```

## ğŸ“¡ API æ¥å£è¯´æ˜

### ç”¨æˆ·ç®¡ç†

#### GET /api/users
- **è¿”å›**ï¼šåŒ…å« `id` å­—æ®µçš„ç”¨æˆ·åˆ—è¡¨
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": 1,
        "name": "111",
        "login_name": "test",
        ...
      }
    ]
  }
}
```

#### POST /api/login
- **è¿”å›**ï¼šåŒ…å« `id` å­—æ®µ
```json
{
  "code": 200,
  "data": {
    "id": 1,          // â† ç”¨æˆ·ID
    "username": "111",
    "role": "111",
    ...
  }
}
```

### ä»»åŠ¡ç®¡ç†

#### GET /api/tasks?user_id=1
- **å‚æ•°**ï¼š`user_id` ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰
- **è¿”å›**ï¼šè¯¥ç”¨æˆ·çš„ä»»åŠ¡åˆ—è¡¨
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "task_name": "ä»»åŠ¡A",
        "user_id": 1,
        ...
      }
    ]
  }
}
```

#### POST /api/tasks
- **è¯·æ±‚ä½“**ï¼šåŒ…å« `user_id`
```json
{
  "task_name": "æ–°ä»»åŠ¡",
  "project": "é¡¹ç›®A",
  "user_id": 1,  // â† å½“å‰ç”¨æˆ·ID
  ...
}
```

#### PUT /api/tasks/<task_name>
- **è¯·æ±‚ä½“**ï¼š`user_id` ä¸å¯ä¿®æ”¹ï¼ˆä¼šè¢«å¿½ç•¥ï¼‰

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•æ•°æ®åº“ç»“æ„
```bash
cd backend
python update_database_structure.py
```

### 2. æµ‹è¯•åç«¯
```bash
# å¯åŠ¨åç«¯
cd backend
python app.py

# æµ‹è¯•ç”¨æˆ·ç™»å½•
curl -X POST http://localhost:5000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"123","password":"123456"}'
# åº”è¿”å›ï¼š{"code": 200, "data": {"id": 3, ...}}

# æµ‹è¯•ç”¨æˆ·éš”ç¦»
curl "http://localhost:5000/api/tasks?user_id=3"
# åº”åªè¿”å› user_id=3 çš„ä»»åŠ¡
```

### 3. æµ‹è¯•å‰ç«¯
1. **ç™»å½•**ï¼šä½¿ç”¨ ID=3 çš„ç”¨æˆ·ï¼ˆ123/123456ï¼‰
2. **æŸ¥çœ‹ä»»åŠ¡**ï¼šåº”è¯¥èƒ½çœ‹åˆ°æ‰€æœ‰ç°æœ‰ä»»åŠ¡ï¼ˆå› ä¸ºå®ƒä»¬çš„ user_id éƒ½æ˜¯ 3ï¼‰
3. **åˆ›å»ºæ–°ä»»åŠ¡**ï¼šåº”è¯¥è‡ªåŠ¨å…³è”åˆ°å½“å‰ç”¨æˆ·ï¼ˆID=3ï¼‰
4. **åˆ‡æ¢ç”¨æˆ·**ï¼šç™»å½• ID=1 çš„ç”¨æˆ·ï¼Œåº”è¯¥çœ‹ä¸åˆ° ID=3 çš„ä»»åŠ¡

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸»é”®å˜æ›´å½±å“
- `tb_user` çš„ä¸»é”®ä» `name` æ”¹ä¸º `id`
- æ‰€æœ‰é€šè¿‡ `name` æŸ¥è¯¢ç”¨æˆ·çš„åœ°æ–¹éœ€è¦æ”¹ä¸º `filter_by(name=...)`

### 2. user_id ä¸å¯ç¼–è¾‘
- `user_id` æ˜¯è‡ªåŠ¨å…³è”çš„ï¼Œä¸å…è®¸æ‰‹åŠ¨ä¿®æ”¹
- å‰ç«¯åº”ç¦ç”¨æˆ–éšè— `user_id` å­—æ®µ

### 3. å‘åå…¼å®¹
- å¦‚æœå‰ç«¯ä¸ä¼  `user_id`ï¼Œåç«¯è¿”å›æ‰€æœ‰æ•°æ®ï¼ˆå‘åå…¼å®¹ï¼‰
- å»ºè®®å‰ç«¯å°½å¿«é€‚é…ï¼Œä¼ é€’ `user_id` å‚æ•°

### 4. ç®¡ç†å‘˜æƒé™
- ç›®å‰æ²¡æœ‰åŒºåˆ†ç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·
- å¦‚éœ€ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰æ•°æ®ï¼Œå¯åœ¨åç«¯æ·»åŠ æƒé™åˆ¤æ–­ï¼š
  ```python
  if user.role == 'super_admin':
      tasks = TaskInfo.query.all()  # ç®¡ç†å‘˜çœ‹æ‰€æœ‰
  else:
      tasks = TaskInfo.query.filter_by(user_id=user.id).all()  # æ™®é€šç”¨æˆ·åªçœ‹è‡ªå·±çš„
  ```

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ å¤–é”®çº¦æŸ
```sql
ALTER TABLE tb_task_info 
ADD CONSTRAINT fk_task_user 
FOREIGN KEY (user_id) REFERENCES tb_user(id) ON DELETE CASCADE;
```

### 2. æ·»åŠ ç´¢å¼•
```sql
CREATE INDEX idx_task_user_id ON tb_task_info(user_id);
CREATE INDEX idx_inspection_user_id ON tb_task_hqzljdjcjlb(user_id);
```

### 3. ä½¿ç”¨ JWT æˆ– Session
- ä¸åœ¨è¯·æ±‚ä¸­ä¼ é€’ `user_id`ï¼ˆä¸å®‰å…¨ï¼‰
- ä½¿ç”¨ JWT token æˆ– Session å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
- åç«¯ä» token/session ä¸­è·å– `user_id`

### 4. æƒé™ç³»ç»Ÿ
- å®ç° RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰
- ç®¡ç†å‘˜å¯æŸ¥çœ‹/ç®¡ç†æ‰€æœ‰æ•°æ®
- æ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹/ç®¡ç†è‡ªå·±çš„æ•°æ®

---

**æ›´æ–°æ—¶é—´**ï¼š2025å¹´9æœˆ30æ—¥  
**æ•°æ®åº“è„šæœ¬**ï¼š`backend/update_database_structure.py`  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… æ•°æ®åº“ç»“æ„æ›´æ–°å®Œæˆï¼ŒModels å·²æ›´æ–°ï¼ŒControllers å·²æ›´æ–°  
**å‰ç«¯é€‚é…**ï¼šâ³ å¾…å‰ç«¯ä¿®æ”¹
